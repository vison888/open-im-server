# å•èŠæ¶ˆæ¯ï¼ˆç¬¬ä¸€é˜¶æ®µï¼‰å‘é€æµç¨‹æºç è¯¦è§£

## ğŸ“± **é˜¶æ®µä¸€ï¼šæ¶ˆæ¯å‘é€å®Œæ•´é“¾è·¯åˆ†æ**

### ğŸ”„ **æµç¨‹æ¦‚è§ˆ**

å•èŠæ¶ˆæ¯å‘é€ç¬¬ä¸€é˜¶æ®µæ¶µç›–äº†ä»Androidå®¢æˆ·ç«¯åˆ›å»ºæ¶ˆæ¯åˆ°æœåŠ¡ç«¯å¤„ç†å®Œæˆçš„å®Œæ•´é“¾è·¯ï¼š

```
Androidå®¢æˆ·ç«¯ â†’ OpenIM SDK â†’ WebSocketé•¿è¿æ¥ â†’ æœåŠ¡ç«¯æ¶ˆæ¯ç½‘å…³ â†’ æ¶ˆæ¯æœåŠ¡ â†’ Kafkaé˜Ÿåˆ—
```

---

## ğŸš€ **ç¬¬ä¸€æ­¥ï¼šAndroidå®¢æˆ·ç«¯æ¶ˆæ¯åˆ›å»º**

### **1.1 ç”¨æˆ·è¾“å…¥è§¦å‘æ¶ˆæ¯åˆ›å»º**

**æ–‡ä»¶ä½ç½®**: `BottomInputCote.java:90-109`

```java
// ç”¨æˆ·ç‚¹å‡»å‘é€æŒ‰é’®æˆ–æŒ‰ä¸‹å›è½¦é”®è§¦å‘
view.chatMoreOrSend.setOnClickListener(chatMoreOrSendClick = new OnDedrepClickListener() {
    @Override
    public void click(View v) {
        if (!isSend) {
            // æ˜¾ç¤ºæ›´å¤šåŠŸèƒ½é¢æ¿
            switchFragment(inputExpandFragment);
            return;
        }
        // æ ¸å¿ƒé€»è¾‘ï¼šåˆ›å»ºæ–‡æœ¬æ¶ˆæ¯
        Message msg = OpenIMClient.getInstance().messageManager.createTextMessage(vm.inputMsg.val().toString());
        if (null != msg) {
            // è°ƒç”¨ViewModelå‘é€æ¶ˆæ¯
            vm.sendMsg(msg);
            reset(); // é‡ç½®UIçŠ¶æ€
        }
    }
});
```

**æ ¸å¿ƒè¦ç‚¹**ï¼š
- **è¾“å…¥æ ¡éªŒ**ï¼šæ£€æŸ¥æ˜¯å¦æœ‰å¯å‘é€å†…å®¹ï¼ˆ`isSend`æ ‡å¿—ï¼‰
- **æ¶ˆæ¯åˆ›å»º**ï¼šè°ƒç”¨OpenIM SDKçš„`createTextMessage`æ¥å£
- **UIé‡ç½®**ï¼šå‘é€åæ¸…ç©ºè¾“å…¥æ¡†å’Œç›¸å…³çŠ¶æ€

### **1.2 SDKæ¥å£è°ƒç”¨ï¼ˆJNIæ¡¥æ¥ï¼‰**

**æ–‡ä»¶ä½ç½®**: `conversation_msg.go:57-59`

```go
func CreateTextMessage(operationID string, text string) string {
    // åŒæ­¥è°ƒç”¨ï¼šé€šè¿‡JNIæ¡¥æ¥åˆ°Go SDK
    return syncCall(operationID, IMUserContext.Conversation().CreateTextMessage, text)
}
```

**è°ƒç”¨é“¾è·¯åˆ†æ**ï¼š
1. **Javaå±‚è°ƒç”¨**ï¼šAndroidé€šè¿‡JNIè°ƒç”¨Go SDKæ¥å£
2. **åŒæ­¥æ‰§è¡Œ**ï¼š`syncCall`ç¡®ä¿æ“ä½œå®Œæˆåå†è¿”å›
3. **ä¸Šä¸‹æ–‡ä¼ é€’**ï¼š`IMUserContext`æä¾›å…¨å±€SDKä¸Šä¸‹æ–‡

---

## ğŸ“ **ç¬¬äºŒæ­¥ï¼šSDKæ ¸å¿ƒæ¶ˆæ¯ç»“æ„åˆ›å»º**

### **2.1 æ¶ˆæ¯åŸºç¡€ä¿¡æ¯åˆå§‹åŒ–**

**æ–‡ä»¶ä½ç½®**: `create_message.go:18-27`

```go
func (c *Conversation) CreateTextMessage(ctx context.Context, text string) (*sdk_struct.MsgStruct, error) {
    s := sdk_struct.MsgStruct{}
    // æ ¸å¿ƒæ­¥éª¤ï¼šåˆå§‹åŒ–æ¶ˆæ¯åŸºç¡€ä¿¡æ¯
    err := c.initBasicInfo(ctx, &s, constant.UserMsgType, constant.Text)
    if err != nil {
        return nil, err
    }
    // è®¾ç½®æ–‡æœ¬æ¶ˆæ¯ç‰¹æœ‰å†…å®¹
    s.TextElem = &sdk_struct.TextElem{Content: text}
    return &s, nil
}
```

### **2.2 æ¶ˆæ¯åŸºç¡€å­—æ®µè¯¦ç»†è§£æ**

**æ–‡ä»¶ä½ç½®**: `api.go:1481-1519`

```go
func (c *Conversation) initBasicInfo(ctx context.Context, message *sdk_struct.MsgStruct, msgFrom, contentType int32) error {
    // æ—¶é—´æˆ³è®¾ç½®
    message.CreateTime = utils.GetCurrentTimestampByMill()
    message.SendTime = message.CreateTime

    // æ¶ˆæ¯çŠ¶æ€è®¾ç½®ï¼ˆå…³é”®å­—æ®µï¼‰
    message.IsRead = false                    // é»˜è®¤æœªè¯»çŠ¶æ€
    message.Status = constant.MsgStatusSending // å‘é€ä¸­çŠ¶æ€

    // å‘é€è€…ä¿¡æ¯è®¾ç½®
    message.SendID = c.loginUserID
    message.SenderPlatformID = c.platform

    // ç”Ÿæˆå®¢æˆ·ç«¯æ¶ˆæ¯IDï¼ˆå»é‡å…³é”®ï¼‰
    ClientMsgID := utils.GetMsgID(message.SendID)
    message.ClientMsgID = ClientMsgID

    // æ¶ˆæ¯å±æ€§è®¾ç½®
    message.MsgFrom = msgFrom           // æ¶ˆæ¯æ¥æºï¼ˆç”¨æˆ·/ç³»ç»Ÿ/æœºå™¨äººï¼‰
    message.ContentType = contentType   // å†…å®¹ç±»å‹ï¼ˆæ–‡æœ¬/å›¾ç‰‡/éŸ³é¢‘ç­‰ï¼‰
    
    // è·å–å‘é€è€…ç”¨æˆ·ä¿¡æ¯
    userInfo, err := c.user.GetUserInfoWithCache(ctx, c.loginUserID)
    if err != nil {
        return err
    }
    message.SenderFaceURL = userInfo.FaceURL
    message.SenderNickname = userInfo.Nickname

    return nil
}
```

**æ ¸å¿ƒå­—æ®µè¯´æ˜**ï¼š

| å­—æ®µå | ç±»å‹ | ä½œç”¨ | åˆå§‹å€¼ |
|--------|------|------|---------|
| **ClientMsgID** | string | å®¢æˆ·ç«¯å”¯ä¸€æ ‡è¯†ï¼Œé˜²é‡å‘ | UUIDæ ¼å¼ |
| **IsRead** | bool | å·²è¯»çŠ¶æ€æ ‡è®° | `false` |
| **Status** | int32 | æ¶ˆæ¯å‘é€çŠ¶æ€ | `MsgStatusSending(1)` |
| **CreateTime** | int64 | æœ¬åœ°åˆ›å»ºæ—¶é—´æˆ³ | å½“å‰æ¯«ç§’æ—¶é—´æˆ³ |
| **SendTime** | int64 | å‘é€æ—¶é—´æˆ³ | åˆå§‹ç­‰äºCreateTime |
| **SendID** | string | å‘é€è€…ç”¨æˆ·ID | å½“å‰ç™»å½•ç”¨æˆ·ID |
| **ContentType** | int32 | æ¶ˆæ¯å†…å®¹ç±»å‹ | `Text(101)` |

---

## ğŸ“¤ **ç¬¬ä¸‰æ­¥ï¼šAndroidç«¯å‘é€æ¶ˆæ¯**

### **3.1 ViewModelè°ƒç”¨å‘é€**

**æ–‡ä»¶ä½ç½®**: `ChatVM.java:843-894`

```java
public void sendMsg(Message msg) {
    sendMsg(msg, false); // éé‡å‘æ¨¡å¼
}

public void sendMsg(Message msg, boolean isResend) {
    // æ¶ˆæ¯å»é‡æ£€æŸ¥
    if (!isResend) {
        for (Message message : mMsgList) {
            if (TextUtils.equals(message.getClientMsgID(), msg.getClientMsgID())) {
                return; // é˜²æ­¢é‡å¤å‘é€
            }
        }
    }

    // æ·»åŠ åˆ°æœ¬åœ°æ¶ˆæ¯åˆ—è¡¨ï¼ˆç«‹å³æ˜¾ç¤ºï¼‰
    insertMessageToList(msg);

    // è°ƒç”¨SDKå‘é€æ¶ˆæ¯ï¼ˆå¼‚æ­¥æ“ä½œï¼‰
    OpenIMClient.getInstance().messageManager.sendMessage(
        new OnMsgSendCallback() {
            @Override
            public void onError(int code, String error) {
                // ğŸ”´ å‘é€å¤±è´¥å¤„ç†
                msg.setStatus(MessageStatus.SEND_FAILURE);
                updateMsgStatusAndRefresh(msg);
            }

            @Override
            public void onSuccess(Message message) {
                // ğŸŸ¢ å‘é€æˆåŠŸå¤„ç†
                msg.setStatus(MessageStatus.SEND_SUCCESS);
                msg.setServerMsgID(message.getServerMsgID());
                msg.setSendTime(message.getSendTime());
                updateMsgStatusAndRefresh(msg);
            }
        }, msg, userID, groupID, null
    );
}
```

**å…³é”®é€»è¾‘**ï¼š
1. **å»é‡ä¿æŠ¤**ï¼šæ£€æŸ¥ClientMsgIDé˜²æ­¢é‡å¤å‘é€
2. **ä¹è§‚æ›´æ–°**ï¼šç«‹å³æ˜¾ç¤ºæ¶ˆæ¯åœ¨èŠå¤©ç•Œé¢
3. **å¼‚æ­¥å‘é€**ï¼šè°ƒç”¨SDKå¼‚æ­¥å‘é€ï¼Œé€šè¿‡å›è°ƒæ›´æ–°çŠ¶æ€

---

## ğŸ”— **ç¬¬å››æ­¥ï¼šSDKåç¨‹è°ƒç”¨æœºåˆ¶**

### **4.1 å¼‚æ­¥è°ƒç”¨å°è£…**

**æ–‡ä»¶ä½ç½®**: `conversation_msg.go:119-121`

```go
func SendMessage(callback open_im_sdk_callback.SendMsgCallBack, operationID, message, recvID, groupID, offlinePushInfo string, isOnlineOnly bool) {
    // æ¶ˆæ¯å‘é€ä¸“ç”¨åç¨‹è°ƒç”¨
    messageCall(callback, operationID, IMUserContext.Conversation().SendMessage, message, recvID, groupID, offlinePushInfo, isOnlineOnly)
}
```

### **4.2 åç¨‹è°ƒç”¨å®ç°**

**æ–‡ä»¶ä½ç½®**: `caller.go:361-485`

```go
func messageCall(callback open_im_sdk_callback.SendMsgCallBack, operationID string, fn any, args ...any) {
    // å¯åŠ¨ç‹¬ç«‹åç¨‹å¤„ç†æ¶ˆæ¯å‘é€
    go messageCall_(callback, operationID, fn, args...)
}

func messageCall_(callback open_im_sdk_callback.SendMsgCallBack, operationID string, fn any, args ...any) {
    // å¼‚å¸¸å¤„ç†å’Œç»“æœå›è°ƒ
    defer func() {
        if r := recover(); r != nil {
            callback.OnError(sdkerrs.ErrInternalServer.ErrCode, fmt.Sprintf("messageCall panic: %+v", r))
        }
    }()

    // åå°„è°ƒç”¨å®é™…å‘é€æ–¹æ³•
    res, err := call_(operationID, fn, args...)
    if err != nil {
        callback.OnError(err.(*sdkerrs.CodeError).ErrCode, err.Error())
        return
    }

    // å‘é€æˆåŠŸå›è°ƒ
    callback.OnSuccess(res.(string))
}
```

**è®¾è®¡è¦ç‚¹**ï¼š
- **å¼‚æ­¥æ‰§è¡Œ**ï¼šæ‰€æœ‰SDKè°ƒç”¨éƒ½åœ¨ç‹¬ç«‹åç¨‹ä¸­æ‰§è¡Œ
- **å¼‚å¸¸ä¿æŠ¤**ï¼š`defer recover()`ç¡®ä¿å¼‚å¸¸ä¸ä¼šå´©æºƒä¸»çº¿ç¨‹
- **å›è°ƒæœºåˆ¶**ï¼šé€šè¿‡callbackå°†ç»“æœè¿”å›ç»™ä¸Šå±‚

---

## ğŸ“¨ **ç¬¬äº”æ­¥ï¼šSDKæ ¸å¿ƒå‘é€é€»è¾‘**

### **5.1 æ¶ˆæ¯å‘é€ä¸»æµç¨‹**

**æ–‡ä»¶ä½ç½®**: `api.go:489-600`

```go
func (c *Conversation) SendMessage(ctx context.Context, s *sdk_struct.MsgStruct, recvID, groupID string, p *sdkws.OfflinePushInfo, isOnlineOnly bool) (*sdk_struct.MsgStruct, error) {
    // ç¬¬ä¸€æ­¥ï¼šæ ¡éªŒå’Œè®¾ç½®æ¶ˆæ¯æ¥æ”¶è€…
    lc, err := c.checkID(ctx, s, recvID, groupID, options)
    if err != nil {
        return s, err
    }

    // ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å­˜åœ¨ï¼ˆé˜²é‡å‘ï¼‰
    oldMessage, err := c.db.GetMessage(ctx, lc.ConversationID, s.ClientMsgID)
    if err == nil {
        // æ¶ˆæ¯å·²å­˜åœ¨ï¼Œæ£€æŸ¥æ˜¯å¦ä¸ºå¤±è´¥é‡å‘
        if oldMessage.Status != constant.MsgStatusSendFailure {
            return nil, sdkerrs.ErrRepeatMessage
        }
        // å¤±è´¥é‡å‘ï¼šæ›´æ–°æ¶ˆæ¯çŠ¶æ€
        s.Status = constant.MsgStatusSending
        s.SendTime = utils.GetCurrentTimestampByMill()
    } else {
        // ç¬¬ä¸‰æ­¥ï¼šæ–°æ¶ˆæ¯å…¥åº“
        err = c.db.InsertMessage(ctx, lc.ConversationID, s)
        if err != nil {
            return s, err
        }
        
        // ç¬¬å››æ­¥ï¼šæ’å…¥å‘é€ä¸­è®°å½•
        err = c.db.InsertSendingMessage(ctx, lc.ConversationID, s.ClientMsgID)
        if err != nil {
            log.ZWarn(ctx, "InsertSendingMessage failed", err)
        }
    }

    // ç¬¬äº”æ­¥ï¼šè§¦å‘ä¼šè¯æ›´æ–°äº‹ä»¶
    c.msgListener().OnMsgSendCallback(&CallbackMessage{
        LocalEx: constant.AddConOrUpLatMsg,
        Msg:     s,
        ConversationMsg: &model_struct.LocalConversation{
            ConversationID: lc.ConversationID,
            LatestMsg:      utils.StructToJsonString(s),
        },
    })

    // ç¬¬å…­æ­¥ï¼šå‘é€åˆ°æœåŠ¡ç«¯
    return c.sendMessageToServer(ctx, s, lc, callback, delFiles, p, options, isOnlineOnly)
}
```

### **5.2 IDæ ¡éªŒå’Œä¼šè¯è®¾ç½®**

**æ–‡ä»¶ä½ç½®**: `api.go:348-444`

```go
func (c *Conversation) checkID(ctx context.Context, s *sdk_struct.MsgStruct, recvID, groupID string, options map[string]bool) (*model_struct.LocalConversation, error) {
    // å‚æ•°æ ¡éªŒ
    if recvID == "" && groupID == "" {
        return nil, sdkerrs.ErrArgs.WrapMsg("recv_id and group_id are both empty")
    }
    if recvID != "" && groupID != "" {
        return nil, sdkerrs.ErrArgs.WrapMsg("recv_id and group_id cannot both be set")
    }

    var lc model_struct.LocalConversation
    
    if recvID != "" {
        // å•èŠé€»è¾‘
        lc.ConversationID = c.getConversationIDBySessionType(recvID, constant.SingleChatType)
        lc.UserID = recvID
        lc.ConversationType = constant.SingleChatType
        lc.FaceURL = faceUrl
        lc.ShowName = name
    } else {
        // ç¾¤èŠé€»è¾‘ï¼ˆæ­¤å¤„çœç•¥ï¼‰
    }

    // è®¾ç½®æ¶ˆæ¯å­—æ®µ
    s.SendID = c.loginUserID
    s.SenderPlatformID = c.platform
    s.ConversationID = lc.ConversationID
    s.SessionType = lc.ConversationType

    return &lc, nil
}
```

---

## ğŸŒ **ç¬¬å…­æ­¥ï¼šWebSocketé•¿è¿æ¥å‘é€**

### **6.1 æœåŠ¡ç«¯å‘é€æ¥å£è°ƒç”¨**

**æ–‡ä»¶ä½ç½®**: `api.go:933-1021`

```go
func (c *Conversation) sendMessageToServer(ctx context.Context, s *sdk_struct.MsgStruct, lc *model_struct.LocalConversation, callback open_im_sdk_callback.SendMsgCallBack, delFiles []string, offlinePushInfo *sdkws.OfflinePushInfo, options map[string]bool, isOnlineOnly bool) (*sdk_struct.MsgStruct, error) {
    
    // æ„å»ºå‘é€è¯·æ±‚
    req := &msg.SendMsgReq{
        MsgData:         convert.MsgStructToPb(s),
        OfflinePushInfo: offlinePushInfo,
        IsOnlineOnly:    isOnlineOnly,
    }

    // å…³é”®æ­¥éª¤ï¼šé€šè¿‡é•¿è¿æ¥å‘é€ï¼ˆé˜»å¡ç­‰å¾…å“åº”ï¼‰
    resp, err := c.LongConnMgr.SendReqWaitResp(ctx, req, constant.WSSendMsg, &msg.SendMsgResp{})
    if err != nil {
        return s, err
    }

    // è§£ææœåŠ¡ç«¯å“åº”
    msgResp := resp.(*msg.SendMsgResp)
    s.SendTime = msgResp.SendTime
    s.ServerMsgID = msgResp.ServerMsgID
    s.Status = constant.MsgStatusSendSuccess

    // æ›´æ–°æœ¬åœ°æ•°æ®åº“
    c.updateMsgStatusAndTriggerConversation(ctx, s.ClientMsgID, s.ServerMsgID, s.SendTime, s.Status, s, lc, isOnlineOnly)

    return s, nil
}
```

### **6.2 é•¿è¿æ¥ç®¡ç†å™¨å‘é€å®ç°**

**æ–‡ä»¶ä½ç½®**: `long_conn_mgr.go:192-241`

```go
func (c *LongConnMgr) SendReqWaitResp(ctx context.Context, m proto.Message, reqIdentifier int, resp proto.Message) error {
    // åºåˆ—åŒ–è¯·æ±‚æ¶ˆæ¯
    data, err := proto.Marshal(m)
    if err != nil {
        return err
    }

    // æ„å»ºWebSocketè¯·æ±‚
    req := GeneralWsReq{
        ReqIdentifier: reqIdentifier,
        Token:         c.token,
        SendID:        c.userID,
        OperationID:   mcontext.GetOperationID(ctx),
        MsgIncr:       GenMsgIncr(c.userID),
        Data:          data,
    }

    // å‘é€å¹¶ç­‰å¾…å“åº”ï¼ˆå…³é”®é˜»å¡ç‚¹ï¼‰
    wsResp, err := c.sendAndWaitResp(&req)
    if err != nil {
        return err
    }

    // è§£æå“åº”æ•°æ®
    if wsResp.ErrCode != 0 {
        return sdkerrs.NewCodeError(wsResp.ErrCode, wsResp.ErrMsg)
    }

    return proto.Unmarshal(wsResp.Data, resp)
}
```

### **6.3 å¼‚æ­¥å“åº”å¤„ç†æœºåˆ¶**

**æ–‡ä»¶ä½ç½®**: `long_conn_mgr.go:504-531`

```go
func (c *LongConnMgr) sendAndWaitResp(msg *GeneralWsReq) (*GeneralWsResp, error) {
    // åˆ›å»ºå“åº”é€šé“
    ch, err := c.writeBinaryMsgAndRetry(msg)
    if err != nil {
        return nil, err
    }

    // ç¡®ä¿æ¸…ç†å“åº”é€šé“
    defer c.Syncer.DelCh(msg.MsgIncr)

    // ç­‰å¾…å“åº”ï¼ˆè¶…æ—¶30ç§’ï¼‰
    select {
    case resp := <-ch:
        if resp == nil {
            return nil, errors.New("response channel closed")
        }
        return resp, nil
    case <-time.After(30 * time.Second):
        return nil, errors.New("send message timeout")
    }
}
```

### **6.4 WebSocketè¿æ¥å¤ç”¨å’Œé‡è¯•æœºåˆ¶**

**æ–‡ä»¶ä½ç½®**: `long_conn_mgr.go:532-569`

```go
func (c *LongConnMgr) writeBinaryMsgAndRetry(msg *GeneralWsReq) (chan *GeneralWsResp, error) {
    // å…³é”®æœºåˆ¶ï¼šé€šè¿‡MsgIncrå»ºç«‹è¯·æ±‚-å“åº”ç»‘å®šå…³ç³»
    msgIncr, ch := c.Syncer.AddCh(c.userID)
    msg.MsgIncr = msgIncr  // è®¾ç½®æ¶ˆæ¯å¢é‡IDï¼Œè¿™æ˜¯åŒæ­¥çš„æ ¸å¿ƒ
    
    // é‡è¯•æœºåˆ¶ï¼šæœ€å¤šé‡è¯•3æ¬¡
    var err error
    for i := 0; i < 3; i++ {
        err = c.writeBinaryMsg(*msg)
        if err == nil {
            return ch, nil  // å‘é€æˆåŠŸï¼Œè¿”å›å“åº”é€šé“
        }
        
        // è¿æ¥å¼‚å¸¸å¤„ç†ï¼šå°è¯•é‡è¿
        if c.IsConnected() {
            continue  // è¿æ¥æ­£å¸¸ä½†å‘é€å¤±è´¥ï¼Œç›´æ¥é‡è¯•
        }
        
        // è¿æ¥æ–­å¼€ï¼šç­‰å¾…é‡è¿å®Œæˆ
        select {
        case <-c.ctx.Done():
            return nil, c.ctx.Err()
        case <-time.After(time.Second * 2):
            // ç­‰å¾…2ç§’åé‡è¯•ï¼Œç»™é‡è¿æœºåˆ¶æ—¶é—´
        }
    }
    
    // é‡è¯•å¤±è´¥ï¼šæ¸…ç†é€šé“å¹¶è¿”å›é”™è¯¯
    c.Syncer.DelCh(msgIncr)
    return nil, fmt.Errorf("writeBinaryMsgAndRetry failed after 3 attempts: %w", err)
}
```

**MsgIncræœºåˆ¶çš„æ ¸å¿ƒä½œç”¨**ï¼š

1. **å”¯ä¸€æ ‡è¯†**ï¼šæ¯ä¸ªWebSocketè¯·æ±‚éƒ½æœ‰å”¯ä¸€çš„MsgIncræ ‡è¯†
2. **ä¸Šä¸‹æ–‡ç»‘å®š**ï¼šå»ºç«‹å‘é€åç¨‹å’Œå“åº”åç¨‹ä¹‹é—´çš„å…³è”
3. **å¹¶å‘å®‰å…¨**ï¼šå¤šä¸ªåç¨‹åŒæ—¶å‘é€æ¶ˆæ¯æ—¶ä¸ä¼šä¸²æ‰°
4. **è¶…æ—¶æ§åˆ¶**ï¼šæ”¯æŒå•ç‹¬çš„è¯·æ±‚è¶…æ—¶å’Œæ¸…ç†
5. **é‡è¿æ¢å¤**ï¼šè¿æ¥æ–­å¼€é‡è¿åèƒ½æ­£ç¡®åŒ¹é…å“åº”

**å¼‚æ­¥å“åº”åŸç†**ï¼š

**æ–‡ä»¶ä½ç½®**: `ws_resp_asyn.go:61-86`

```go
func (u *WsRespAsyn) AddCh(userID string) (string, chan *GeneralWsResp) {
    u.wsMutex.Lock()
    defer u.wsMutex.Unlock()
    
    // ç”Ÿæˆå”¯ä¸€æ¶ˆæ¯å¢é‡ID
    msgIncr := GenMsgIncr(userID)
    ch := make(chan *GeneralWsResp, 1)
    
    // æ³¨å†Œå“åº”é€šé“
    u.wsNotification[msgIncr] = ch
    return msgIncr, ch
}

func (u *WsRespAsyn) NotifyResp(ctx context.Context, wsResp GeneralWsResp) error {
    u.wsMutex.RLock()
    ch, exists := u.wsNotification[wsResp.MsgIncr]
    u.wsMutex.RUnlock()
    
    if !exists {
        return errors.New("notification channel not found")
    }

    // é€šçŸ¥ç­‰å¾…çš„åç¨‹
    return u.notifyCh(ch, &wsResp, 3000) // 3ç§’è¶…æ—¶
}
```

**WebSocketåŒæ­¥æœºåˆ¶æ€»ç»“**ï¼š

| é˜¶æ®µ | æ“ä½œ | MsgIncrä½œç”¨ | å¹¶å‘å¤„ç† |
|------|------|-------------|----------|
| **è¯·æ±‚å‘é€** | ç”ŸæˆMsgIncrå¹¶æ³¨å†Œé€šé“ | å»ºç«‹å”¯ä¸€æ ‡è¯† | çº¿ç¨‹å®‰å…¨çš„mapæ“ä½œ |
| **ç­‰å¾…å“åº”** | é˜»å¡åœ¨channelä¸Š | é€šè¿‡MsgIncråŒ¹é…å“åº” | æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹çš„channel |
| **æ¥æ”¶å“åº”** | æœåŠ¡ç«¯è¿”å›ç›¸åŒMsgIncr | ç²¾ç¡®è·¯ç”±åˆ°å¯¹åº”åç¨‹ | é¿å…å“åº”ä¸²æ‰° |
| **æ¸…ç†èµ„æº** | åˆ é™¤é€šé“å’ŒMsgIncræ˜ å°„ | é˜²æ­¢å†…å­˜æ³„éœ² | ç¡®ä¿èµ„æºåŠæ—¶é‡Šæ”¾ |

---

## ğŸŒ **ç¬¬ä¸ƒæ­¥ï¼šæœåŠ¡ç«¯æ¶ˆæ¯æ¥æ”¶å¤„ç†**

### **7.1 WebSocketæœåŠ¡å™¨æ¶ˆæ¯è¯»å–**

**æ–‡ä»¶ä½ç½®**: `ws_server.go:768-850`

```go
func (ws *WsServer) wsHandler(w http.ResponseWriter, r *http.Request) {
    // å‡çº§ä¸ºWebSocketè¿æ¥
    conn, err := ws.upgrader.Upgrade(w, r, nil)
    if err != nil {
        return
    }

    // åˆ›å»ºå®¢æˆ·ç«¯è¿æ¥å¯¹è±¡
    client := ws.clientPool.Get().(*Client)
    client.ResetClient(&UserConnContext{...}, newGWebSocket(conn), ws)

    // å¯åŠ¨æ¶ˆæ¯è¯»å–åç¨‹
    go client.readMessage()
}
```

### **7.2 å®¢æˆ·ç«¯æ¶ˆæ¯å¤„ç†**

**æ–‡ä»¶ä½ç½®**: `client.go:186-263`

```go
func (c *Client) readMessage() {
    defer func() {
        c.close()                    // ç¡®ä¿è¿æ¥å…³é—­
        c.longConnServer.UnRegister(c) // æ³¨é”€å®¢æˆ·ç«¯
    }()

    for {
        // è¯»å–WebSocketæ¶ˆæ¯
        _, message, err := c.conn.ReadMessage()
        if err != nil {
            return
        }

        // å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
        if err := c.handleMessage(message); err != nil {
            log.ZError(context.Background(), "handle message error", err)
        }
    }
}

func (c *Client) handleMessage(message []byte) error {
    var binaryReq Req
    err := c.Encoder.Decode(message, &binaryReq)
    if err != nil {
        return err
    }

    // æ ¹æ®è¯·æ±‚æ ‡è¯†ç¬¦è·¯ç”±æ¶ˆæ¯
    switch binaryReq.ReqIdentifier {
    case WSSendMsg:
        // å¤„ç†å‘é€æ¶ˆæ¯è¯·æ±‚
        return c.longConnServer.SendMessage(ctx, &binaryReq)
    case WSPullMsgBySeqList:
        // å¤„ç†æ‹‰å–æ¶ˆæ¯è¯·æ±‚
        return c.longConnServer.PullMessageBySeqList(ctx, &binaryReq)
    default:
        return fmt.Errorf("unknown request identifier: %d", binaryReq.ReqIdentifier)
    }
}
```

### **7.3 æ¶ˆæ¯ç½‘å…³è°ƒç”¨æ¶ˆæ¯æœåŠ¡**

**æ–‡ä»¶ä½ç½®**: `message_handler.go:169-194`

```go
// SendMessage handles the sending of messages through gRPC. It unmarshals the request data,
// validates the message, and then sends it using the message RPC client.
func (g *GrpcHandler) SendMessage(ctx context.Context, data *Req) ([]byte, error) {
    var msgData sdkws.MsgData
    if err := proto.Unmarshal(data.Data, &msgData); err != nil {
        return nil, errs.WrapMsg(err, "SendMessage: error unmarshaling message data", "action", "unmarshal", "dataType", "MsgData")
    }

    if err := g.validate.Struct(&msgData); err != nil {
        return nil, errs.WrapMsg(err, "SendMessage: message data validation failed", "action", "validate", "dataType", "MsgData")
    }

    req := msg.SendMsgReq{MsgData: &msgData}
    // è°ƒç”¨æ¶ˆæ¯æœåŠ¡RPCæ¥å£ï¼ˆé˜»å¡è°ƒç”¨ï¼‰
    resp, err := g.msgClient.MsgClient.SendMsg(ctx, &req)
    if err != nil {
        return nil, err
    }

    // åºåˆ—åŒ–å“åº”æ•°æ®
    c, err := proto.Marshal(resp)
    if err != nil {
        return nil, errs.WrapMsg(err, "SendMessage: error marshaling response", "action", "marshal", "dataType", "SendMsgResp")
    }

    return c, nil
}
```

**æ¶ˆæ¯ç½‘å…³å¤„ç†æµç¨‹**ï¼š
1. **æ¶ˆæ¯è§£æ**ï¼šå°†WebSocketäºŒè¿›åˆ¶æ•°æ®è§£æä¸ºMsgDataç»“æ„
2. **æ•°æ®éªŒè¯**ï¼šéªŒè¯æ¶ˆæ¯æ•°æ®çš„å®Œæ•´æ€§å’Œåˆæ³•æ€§
3. **RPCè°ƒç”¨**ï¼šåŒæ­¥è°ƒç”¨æ¶ˆæ¯æœåŠ¡çš„SendMsgæ¥å£
4. **å“åº”å¤„ç†**ï¼šå°†RPCå“åº”åºåˆ—åŒ–åè¿”å›ç»™å®¢æˆ·ç«¯

---

## ğŸ“® **ç¬¬å…«æ­¥ï¼šæ¶ˆæ¯æœåŠ¡RPCå¤„ç†**

### **8.1 æ¶ˆæ¯æœåŠ¡æ ¸å¿ƒå‘é€é€»è¾‘**

**æ–‡ä»¶ä½ç½®**: `send.go:37-61`

```go
func (m *msgServer) SendMsg(ctx context.Context, req *pbmsg.SendMsgReq) (*pbmsg.SendMsgResp, error) {
    // ç¬¬ä¸€æ­¥ï¼šæ¶ˆæ¯æ•°æ®å°è£…
    m.encapsulateMsgData(req.MsgData)

    // ç¬¬äºŒæ­¥ï¼šæ¶ˆæ¯éªŒè¯
    if err := m.messageVerification(ctx, req); err != nil {
        return nil, err
    }

    // ç¬¬ä¸‰æ­¥ï¼šæ ¹æ®ä¼šè¯ç±»å‹å¤„ç†
    switch req.MsgData.SessionType {
    case constant.SingleChatType:
        return m.sendMsgSingleChat(ctx, req)
    case constant.GroupChatType:
        return m.sendMsgGroupChat(ctx, req)
    case constant.NotificationChatType:
        return m.sendMsgNotification(ctx, req)
    default:
        return nil, sdkerrs.ErrArgs.WrapMsg("invalid session type")
    }
}
```

### **8.2 æ¶ˆæ¯æ•°æ®å°è£…**

**æ–‡ä»¶ä½ç½®**: `verify.go:177-236`

```go
func (m *msgServer) encapsulateMsgData(msg *sdkws.MsgData) {
    // ç”Ÿæˆå”¯ä¸€çš„æœåŠ¡å™¨æ¶ˆæ¯ID
    msg.ServerMsgID = GetMsgID(msg.SendID)

    // è®¾ç½®å‘é€æ—¶é—´ï¼ˆå¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰æä¾›ï¼‰
    if msg.SendTime == 0 {
        msg.SendTime = timeutil.GetCurrentTimestampByMill()
    }

    // è®¾ç½®æ¶ˆæ¯é€‰é¡¹ï¼ˆé»˜è®¤é…ç½®ï¼‰
    if msg.Options == nil {
        msg.Options = msgprocessor.NewMsgOptions()
    }
}

func GetMsgID(sendID string) string {
    // ä½¿ç”¨æ—¶é—´æˆ³ + ç”¨æˆ·ID + éšæœºæ•°ç”Ÿæˆå”¯ä¸€ID
    return utils.Md5(fmt.Sprintf("%d%s%d", timeutil.GetCurrentTimestampByMill(), sendID, rand.Int63()))
}
```

### **8.3 å•èŠæ¶ˆæ¯å¤„ç†**

**æ–‡ä»¶ä½ç½®**: `send.go:216-280`

```go
func (m *msgServer) sendMsgSingleChat(ctx context.Context, req *pbmsg.SendMsgReq) (resp *pbmsg.SendMsgResp, err error) {
    // ç¬¬ä¸€æ­¥ï¼šå¥½å‹å…³ç³»å’Œé»‘åå•éªŒè¯
    if err := m.verifyFriendship(ctx, req.MsgData.SendID, req.MsgData.RecvID); err != nil {
        return nil, err
    }

    // ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥æ¥æ”¶æ–¹æ¶ˆæ¯æ¥æ”¶è®¾ç½®
    canSend, err := m.modifyMessageByUserMessageReceiveOpt(ctx, req.MsgData.RecvID, 
        utils.GetConversationIDByMsg(req.MsgData), int(req.MsgData.SessionType), req)
    if err != nil {
        return nil, err
    }
    if !canSend {
        // å¯¹æ–¹è®¾ç½®äº†ä¸æ¥æ”¶æ¶ˆæ¯
        return &pbmsg.SendMsgResp{
            ServerMsgID: req.MsgData.ServerMsgID,
            SendTime:    req.MsgData.SendTime,
        }, nil
    }

    // ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆä¼šè¯å”¯ä¸€é”®
    conversationID := msgprocessor.GetConversationIDByMsg(req.MsgData)

    // ç¬¬å››æ­¥ï¼šè®¾ç½®æ¶ˆæ¯é€‰é¡¹
    options := msgprocessor.Options(req.MsgData.Options)
    if !options.IsNotNotification() {
        // æ™®é€šæ¶ˆæ¯ï¼Œè®¾ç½®æ¨é€é€‰é¡¹
        req.MsgData.Options = msgprocessor.WithOptions(req.MsgData.Options,
            msgprocessor.WithOfflinePush(true),
            msgprocessor.WithUnreadCount(true),
        )
    }

    // ç¬¬äº”æ­¥ï¼šå°†æ¶ˆæ¯æŠ•é€’åˆ°æ¶ˆæ¯é˜Ÿåˆ—
    if err := m.MsgDatabase.MsgToMQ(ctx, conversationutil.GenConversationUniqueKeyForSingle(req.MsgData.SendID, req.MsgData.RecvID), req.MsgData); err != nil {
        prommetrics.SingleChatMsgProcessFailedCounter.Inc()
        return nil, err
    }

    // ç¬¬å…­æ­¥ï¼šè¿”å›æˆåŠŸå“åº”
    prommetrics.SingleChatMsgProcessSuccessCounter.Inc()
    return &pbmsg.SendMsgResp{
        ServerMsgID: req.MsgData.ServerMsgID,
        SendTime:    req.MsgData.SendTime,
    }, nil
}
```

### **8.4 ç”¨æˆ·æ¶ˆæ¯æ¥æ”¶è®¾ç½®æ£€æŸ¥**

**æ–‡ä»¶ä½ç½®**: `verify.go:244-300`

```go
func (m *msgServer) modifyMessageByUserMessageReceiveOpt(ctx context.Context, userID, conversationID string, sessionType int, pb *msg.SendMsgReq) (bool, error) {
    // è·å–ç”¨æˆ·çš„å…¨å±€æ¶ˆæ¯æ¥æ”¶è®¾ç½®
    opt, err := m.UserLocalCache.GetUserGlobalMsgRecvOpt(ctx, userID)
    if err != nil {
        return false, err
    }

    switch opt {
    case constant.ReceiveMessage:
        // æ­£å¸¸æ¥æ”¶æ¶ˆæ¯

    case constant.NotReceiveMessage:
        // ä¸æ¥æ”¶ä»»ä½•æ¶ˆæ¯
        return false, nil

    case constant.ReceiveNotNotifyMessage:
        // æ¥æ”¶æ¶ˆæ¯ä½†ä¸æ¨é€é€šçŸ¥
        if pb.MsgData.Options == nil {
            pb.MsgData.Options = make(map[string]bool, 10)
        }
        // å…³é—­ç¦»çº¿æ¨é€é€‰é¡¹
        datautil.SetSwitchFromOptions(pb.MsgData.Options, constant.IsOfflinePush, false)
        return true, nil
    }

    // æ£€æŸ¥ä¼šè¯çº§åˆ«çš„æ¥æ”¶è®¾ç½®
    singleOpt, err := m.ConversationLocalCache.GetSingleConversationRecvMsgOpt(ctx, userID, conversationID)
    if errs.ErrRecordNotFound.Is(err) {
        return true, nil
    } else if err != nil {
        return false, err
    }

    switch singleOpt {
    case constant.ReceiveMessage:
        return true, nil
    case constant.NotReceiveMessage:
        // ç‰¹æ®Šæ¶ˆæ¯ç±»å‹ä»éœ€æ¥æ”¶ï¼ˆå¦‚ç³»ç»Ÿé€šçŸ¥ï¼‰
        if datautil.Contain(int(pb.MsgData.ContentType), ExcludeContentType...) {
            return true, nil
        }
        return false, nil
    case constant.ReceiveNotNotifyMessage:
        if pb.MsgData.Options == nil {
            pb.MsgData.Options = make(map[string]bool, 10)
        }
        datautil.SetSwitchFromOptions(pb.MsgData.Options, constant.IsOfflinePush, false)
        return true, nil
    }
    return true, nil
}
```

### **8.5 æ¶ˆæ¯é€‰é¡¹é…ç½®è¯¦è§£**

æ¶ˆæ¯é€‰é¡¹ï¼ˆOptionsï¼‰æ§åˆ¶æ¶ˆæ¯çš„å¤„ç†è¡Œä¸ºï¼ŒOpenIMé€šè¿‡`msgprocessor.Options`ç±»å‹å®ç°ç»†ç²’åº¦çš„æ¶ˆæ¯æ§åˆ¶ã€‚

**æ–‡ä»¶ä½ç½®**: `options.go:31-539`

#### **Optionså­—æ®µè¯¦ç»†è¯´æ˜**

| é€‰é¡¹åç§° | ç±»å‹ | é»˜è®¤å€¼ | ä½œç”¨æè¿° | ä½¿ç”¨åœºæ™¯ |
|----------|------|--------|----------|----------|
| **IsNotNotification** | bool | `false` | **æ˜¯å¦ä¸ºéé€šçŸ¥æ¶ˆæ¯**<br/>â€¢ `true` = ç³»ç»Ÿé€šçŸ¥æ¶ˆæ¯<br/>â€¢ `false` = æ™®é€šç”¨æˆ·æ¶ˆæ¯<br/>â€¢ å½±å“æ¨é€å’Œè®¡æ•°ç­–ç•¥ | ç³»ç»Ÿé€šçŸ¥ã€ç¾¤ç®¡ç†æ¶ˆæ¯ |
| **IsSendMsg** | bool | `true` | **æ˜¯å¦å‘é€æ¶ˆæ¯**<br/>â€¢ `true` = éœ€è¦å‘é€åˆ°æ¥æ”¶æ–¹<br/>â€¢ `false` = ä»…æœ¬åœ°å¤„ç†<br/>â€¢ æ§åˆ¶æ¶ˆæ¯ä¼ é€’è¡Œä¸º | è‰ç¨¿ä¿å­˜ã€æœ¬åœ°è®°å½• |
| **IsHistory** | bool | `true` | **æ˜¯å¦ä¿å­˜å†å²è®°å½•**<br/>â€¢ `true` = æ¶ˆæ¯æŒä¹…åŒ–åˆ°æ•°æ®åº“<br/>â€¢ `false` = ä»…ä¸´æ—¶å¤„ç†<br/>â€¢ å½±å“æ¶ˆæ¯å­˜å‚¨ç­–ç•¥ | ä¸´æ—¶æ¶ˆæ¯ã€é˜…åå³ç„š |
| **IsPersistent** | bool | `true` | **æ˜¯å¦æŒä¹…åŒ–å­˜å‚¨**<br/>â€¢ `true` = å­˜å‚¨åˆ°MongoDB<br/>â€¢ `false` = ä»…ç¼“å­˜å¤„ç†<br/>â€¢ å†³å®šæ•°æ®æŒä¹…æ€§ | é‡è¦æ¶ˆæ¯ã€åˆè§„è¦æ±‚ |
| **IsOfflinePush** | bool | `true` | **æ˜¯å¦ç¦»çº¿æ¨é€**<br/>â€¢ `true` = ç”¨æˆ·ç¦»çº¿æ—¶æ¨é€<br/>â€¢ `false` = ä¸æ¨é€é€šçŸ¥<br/>â€¢ æ§åˆ¶æ¨é€è¡Œä¸º | å…æ‰“æ‰°è®¾ç½®ã€é™é»˜æ¶ˆæ¯ |
| **IsUnreadCount** | bool | `true` | **æ˜¯å¦è®¡å…¥æœªè¯»æ•°**<br/>â€¢ `true` = å¢åŠ æœªè¯»è®¡æ•°<br/>â€¢ `false` = ä¸å½±å“æœªè¯»æ•°<br/>â€¢ å½±å“ä¼šè¯æœªè¯»ç»Ÿè®¡ | ç³»ç»Ÿæç¤ºã€çŠ¶æ€æ¶ˆæ¯ |
| **IsConversationUpdate** | bool | `true` | **æ˜¯å¦æ›´æ–°ä¼šè¯**<br/>â€¢ `true` = æ›´æ–°ä¼šè¯æœ€æ–°æ¶ˆæ¯<br/>â€¢ `false` = ä¸æ›´æ–°ä¼šè¯åˆ—è¡¨<br/>â€¢ æ§åˆ¶ä¼šè¯æ˜¾ç¤º | é™é»˜æ¶ˆæ¯ã€åå°åŒæ­¥ |
| **IsSenderSync** | bool | `true` | **æ˜¯å¦å‘é€è€…åŒæ­¥**<br/>â€¢ `true` = åŒæ­¥åˆ°å‘é€è€…å…¶ä»–è®¾å¤‡<br/>â€¢ `false` = ä»…å‘é€ç»™æ¥æ”¶è€…<br/>â€¢ å¤šç«¯åŒæ­¥æ§åˆ¶ | å•è®¾å¤‡æ¶ˆæ¯ã€ä¸´æ—¶é€šçŸ¥ |
| **IsNotPrivate** | bool | `false` | **æ˜¯å¦éç§å¯†æ¶ˆæ¯**<br/>â€¢ `true` = å…¬å¼€æ¶ˆæ¯<br/>â€¢ `false` = ç§å¯†æ¶ˆæ¯<br/>â€¢ éšç§ä¿æŠ¤ç›¸å…³ | ç¾¤å…¬å‘Šã€ç³»ç»Ÿå¹¿æ’­ |
| **IsSenderConversationUpdate** | bool | `true` | **æ˜¯å¦æ›´æ–°å‘é€è€…ä¼šè¯**<br/>â€¢ `true` = æ›´æ–°å‘é€è€…ä¼šè¯åˆ—è¡¨<br/>â€¢ `false` = ä¸æ›´æ–°å‘é€è€…ä¼šè¯<br/>â€¢ å‘é€è€…ç•Œé¢æ§åˆ¶ | å•å‘æ¶ˆæ¯ã€ç³»ç»Ÿé€šçŸ¥ |
| **IsReactionFromCache** | bool | `false` | **æ˜¯å¦ä»ç¼“å­˜è·å–ååº”**<br/>â€¢ `true` = ä¼˜å…ˆä½¿ç”¨ç¼“å­˜æ•°æ®<br/>â€¢ `false` = å®æ—¶æŸ¥è¯¢æ•°æ®åº“<br/>â€¢ æ€§èƒ½ä¼˜åŒ–é€‰é¡¹ | é«˜é¢‘æŸ¥è¯¢ã€æ€§èƒ½æ•æ„Ÿåœºæ™¯ |

#### **æ¶ˆæ¯é€‰é¡¹çš„ç»„åˆä½¿ç”¨**

```go
// æ™®é€šç”¨æˆ·æ¶ˆæ¯ï¼ˆé»˜è®¤é…ç½®ï¼‰
normalMsgOptions := msgprocessor.NewMsgOptions()
// ç­‰ä»·äºï¼š
// map[string]bool{
//     "isNotNotification": false,
//     "isSendMsg": true,
//     "isHistory": true,
//     "isPersistent": true,
//     "isOfflinePush": true,
//     "isUnreadCount": true,
//     "isConversationUpdate": true,
//     "isSenderSync": true,
//     "isNotPrivate": false,
//     "isSenderConversationUpdate": true,
//     "isReactionFromCache": false,
// }

// ç³»ç»Ÿé€šçŸ¥æ¶ˆæ¯
notificationOptions := msgprocessor.WithOptions(msgprocessor.NewMsgOptions(),
    msgprocessor.WithNotNotification(true),   // æ ‡è®°ä¸ºé€šçŸ¥æ¶ˆæ¯
    msgprocessor.WithOfflinePush(false),      // ä¸æ¨é€
    msgprocessor.WithUnreadCount(false),      // ä¸è®¡å…¥æœªè¯»
)

// é˜…åå³ç„šæ¶ˆæ¯
burnAfterReadOptions := msgprocessor.WithOptions(msgprocessor.NewMsgOptions(),
    msgprocessor.WithHistory(false),          // ä¸ä¿å­˜å†å²
    msgprocessor.WithPersistent(),            // ä½†è¦æŒä¹…åŒ–ï¼ˆç”¨äºè¿½æº¯ï¼‰
    msgprocessor.WithNotPrivate(),            // æ ‡è®°ä¸ºéç§å¯†
)

// ç¾¤ç»„é™é»˜æ¶ˆæ¯
silentGroupMsgOptions := msgprocessor.WithOptions(msgprocessor.NewMsgOptions(),
    msgprocessor.WithOfflinePush(false),      // é™é»˜æ¨é€
    msgprocessor.WithUnreadCount(false),      // ä¸å¢åŠ æœªè¯»æ•°
    msgprocessor.WithConversationUpdate(),    // ä½†æ›´æ–°ä¼šè¯åˆ—è¡¨
)
```

#### **æ¶ˆæ¯é€‰é¡¹çš„åˆ¤æ–­æ–¹æ³•**

```go
// æ£€æŸ¥æ¶ˆæ¯ç±»å‹
if options.IsNotNotification() {
    // å¤„ç†ç³»ç»Ÿé€šçŸ¥é€»è¾‘
}

// æ£€æŸ¥æ˜¯å¦éœ€è¦æ¨é€
if options.IsOfflinePush() {
    // å‘é€ç¦»çº¿æ¨é€
}

// æ£€æŸ¥æ˜¯å¦è®¡å…¥æœªè¯»æ•°
if options.IsUnreadCount() {
    // å¢åŠ æœªè¯»è®¡æ•°
}

// æ£€æŸ¥æ˜¯å¦æ›´æ–°ä¼šè¯
if options.IsConversationUpdate() {
    // æ›´æ–°ä¼šè¯æœ€æ–°æ¶ˆæ¯å’Œæ—¶é—´
}
```

#### **ä¸šåŠ¡åœºæ™¯æ˜ å°„**

| ä¸šåŠ¡åœºæ™¯ | é€‰é¡¹é…ç½® | è¯´æ˜ |
|----------|----------|------|
| **æ™®é€šèŠå¤©æ¶ˆæ¯** | å…¨éƒ¨é»˜è®¤true | å®Œæ•´çš„æ¶ˆæ¯æµç¨‹å’Œç”¨æˆ·ä½“éªŒ |
| **ç³»ç»Ÿé€šçŸ¥** | `IsNotNotification=true`, `IsOfflinePush=false` | ä¸æ¨é€ä½†æ˜¾ç¤ºåœ¨èŠå¤©ä¸­ |
| **è¾“å…¥çŠ¶æ€** | `IsHistory=false`, `IsPersistent=false` | ä¸´æ—¶çŠ¶æ€ï¼Œä¸ä¿å­˜ |
| **å·²è¯»å›æ‰§** | `IsUnreadCount=false`, `IsConversationUpdate=false` | ä¸å½±å“ä¼šè¯çŠ¶æ€ |
| **é˜…åå³ç„š** | `IsHistory=false` | é˜…è¯»åè‡ªåŠ¨åˆ é™¤ |
| **ç¾¤ç®¡ç†æ¶ˆæ¯** | `IsNotNotification=true`, `IsUnreadCount=false` | ç®¡ç†ç±»é€šçŸ¥æ¶ˆæ¯ |
| **æ’¤å›é€šçŸ¥** | `IsNotNotification=true`, `IsOfflinePush=false` | æ’¤å›æç¤ºæ¶ˆæ¯ |

---

## ğŸ“Š **ç¬¬ä¹æ­¥ï¼šæ¶ˆæ¯æŠ•é€’åˆ°Kafkaé˜Ÿåˆ—**

### **9.1 Kafkaæ¶ˆæ¯æŠ•é€’**

```go
// å°†æ¶ˆæ¯æŠ•é€’åˆ°Kafkaé˜Ÿåˆ—è¿›è¡Œå¼‚æ­¥å¤„ç†
func (d *msgDatabase) MsgToMQ(ctx context.Context, key string, msg *sdkws.MsgData) error {
    // åºåˆ—åŒ–æ¶ˆæ¯
    data, err := proto.Marshal(msg)
    if err != nil {
        return err
    }

    // æŠ•é€’åˆ°ä¸åŒçš„Topic
    return d.producer.SendMessage(ctx, &sarama.ProducerMessage{
        Topic: d.config.Kafka.ToRedisTopic,    // æ¶ˆæ¯ç¼“å­˜å¤„ç†
        Key:   sarama.StringEncoder(key),      // åˆ†åŒºé”®ï¼šä¼šè¯ID
        Value: sarama.ByteEncoder(data),       // æ¶ˆæ¯æ•°æ®
    })
}
```

**Kafka Topicåˆ†é…**ï¼š
- **toRedisTopic**: æ¶ˆæ¯ç¼“å­˜å’Œåºåˆ—å·åˆ†é…
- **toMongoTopic**: æ¶ˆæ¯æŒä¹…åŒ–å­˜å‚¨  
- **toPushTopic**: åœ¨çº¿ç”¨æˆ·æ¨é€
- **toOfflinePushTopic**: ç¦»çº¿ç”¨æˆ·æ¨é€

---

## ğŸ”„ **ç¬¬åæ­¥ï¼šå“åº”è¿”å›å’ŒçŠ¶æ€æ›´æ–°**

### **10.1 æœåŠ¡ç«¯å“åº”è¿”å›**

å½“æ¶ˆæ¯æˆåŠŸæŠ•é€’åˆ°Kafkaåï¼ŒæœåŠ¡ç«¯ç«‹å³è¿”å›å“åº”ï¼š

```go
// å“åº”åŒ…å«æœåŠ¡ç«¯ç”Ÿæˆçš„å…³é”®ä¿¡æ¯
response := &pbmsg.SendMsgResp{
    ServerMsgID: req.MsgData.ServerMsgID,  // æœåŠ¡ç«¯æ¶ˆæ¯ID
    SendTime:    req.MsgData.SendTime,     // æœåŠ¡ç«¯æ—¶é—´æˆ³
}
```

### **10.2 å®¢æˆ·ç«¯çŠ¶æ€æ›´æ–°**

**Androidç«¯æ¥æ”¶åˆ°å“åº”åæ›´æ–°UI**ï¼š

```java
@Override
public void onSuccess(Message message) {
    // æ›´æ–°æ¶ˆæ¯çŠ¶æ€ä¸ºå‘é€æˆåŠŸ
    msg.setStatus(MessageStatus.SEND_SUCCESS);
    msg.setServerMsgID(message.getServerMsgID());
    msg.setSendTime(message.getSendTime());
    
    // åˆ·æ–°UIæ˜¾ç¤º
    updateMsgStatusAndRefresh(msg);
}
```

**SDKç«¯æ•°æ®åº“æ›´æ–°**ï¼š

```go
// æ›´æ–°æœ¬åœ°æ•°æ®åº“ä¸­çš„æ¶ˆæ¯çŠ¶æ€
func (c *Conversation) updateMsgStatusAndTriggerConversation(ctx context.Context, clientMsgID, serverMsgID string, sendTime int64, status int32, s *sdk_struct.MsgStruct, lc *model_struct.LocalConversation, isOnlineOnly bool) {
    
    // æ›´æ–°æ¶ˆæ¯å±æ€§
    s.SendTime = sendTime
    s.Status = status
    s.ServerMsgID = serverMsgID

    // æ›´æ–°æ•°æ®åº“ä¸­çš„æ¶ˆæ¯çŠ¶æ€
    err := c.db.UpdateMessageTimeAndStatus(ctx, lc.ConversationID, clientMsgID, serverMsgID, sendTime, status)
    if err != nil {
        log.ZWarn(ctx, "send message update message status error", err)
    }

    // åˆ é™¤å‘é€ä¸­çš„æ¶ˆæ¯è®°å½•
    err = c.db.DeleteSendingMessage(ctx, lc.ConversationID, clientMsgID)
    if err != nil {
        log.ZWarn(ctx, "send message delete sending message error", err)
    }

    // æ›´æ–°ä¼šè¯çš„æœ€æ–°æ¶ˆæ¯
    lc.LatestMsg = utils.StructToJsonString(s)
    lc.LatestMsgSendTime = sendTime

    // è§¦å‘ä¼šè¯æ›´æ–°äº‹ä»¶
    c.msgListener().OnMsgSendCallback(&CallbackMessage{...})
}
```

---

## ğŸ“‹ **æ¶ˆæ¯çŠ¶æ€å˜è¿æ€»ç»“**

| é˜¶æ®µ | çŠ¶æ€å€¼ | çŠ¶æ€åç§° | è¯´æ˜ |
|------|--------|----------|------|
| **åˆå§‹åˆ›å»º** | `1` | `MsgStatusSending` | å®¢æˆ·ç«¯åˆ›å»ºæ¶ˆæ¯æ—¶çš„åˆå§‹çŠ¶æ€ |
| **æœ¬åœ°å­˜å‚¨** | `1` | `MsgStatusSending` | ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“ï¼ŒUIæ˜¾ç¤ºå‘é€ä¸­ |
| **æœåŠ¡ç«¯å¤„ç†** | `1` | `MsgStatusSending` | æœåŠ¡ç«¯å¤„ç†æœŸé—´ä¿æŒå‘é€ä¸­çŠ¶æ€ |
| **å‘é€æˆåŠŸ** | `2` | `MsgStatusSendSuccess` | æœåŠ¡ç«¯è¿”å›æˆåŠŸå“åº”ï¼Œæ›´æ–°çŠ¶æ€ |
| **å‘é€å¤±è´¥** | `3` | `MsgStatusSendFailure` | ç½‘ç»œå¼‚å¸¸æˆ–æœåŠ¡ç«¯é”™è¯¯æ—¶çš„çŠ¶æ€ |


## â±ï¸ **æ—¶åºå›¾**

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant UI as Android UI
    participant VM as ChatViewModel  
    participant SDK as OpenIM SDK
    participant WS as WebSocketé•¿è¿æ¥
    participant GW as æ¶ˆæ¯ç½‘å…³
    participant MSG as æ¶ˆæ¯æœåŠ¡
    participant MQ as Kafkaé˜Ÿåˆ—

    User->>UI: ç‚¹å‡»å‘é€æŒ‰é’®
    UI->>SDK: createTextMessage(text)
    SDK-->>UI: è¿”å›æ¶ˆæ¯å¯¹è±¡
    UI->>VM: sendMsg(message)
    VM->>UI: ç«‹å³æ˜¾ç¤ºæ¶ˆæ¯(å‘é€ä¸­çŠ¶æ€)
    VM->>SDK: sendMessage(callback, message)
    
    Note over SDK: åç¨‹å¤„ç†å‘é€é€»è¾‘
    SDK->>SDK: æ£€æŸ¥æ¶ˆæ¯å»é‡
    SDK->>SDK: ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“
    SDK->>SDK: æ’å…¥å‘é€ä¸­è®°å½•
    SDK->>SDK: è§¦å‘ä¼šè¯æ›´æ–°äº‹ä»¶
    
    SDK->>WS: SendReqWaitResp(æ¶ˆæ¯)
    WS->>GW: WebSocketå‘é€
    GW->>MSG: RPCè°ƒç”¨SendMsg
    
    Note over MSG: æœåŠ¡ç«¯å¤„ç†é€»è¾‘
    MSG->>MSG: æ¶ˆæ¯éªŒè¯å’Œå°è£…
    MSG->>MSG: å¥½å‹å…³ç³»éªŒè¯
    MSG->>MSG: æ¶ˆæ¯æ¥æ”¶è®¾ç½®æ£€æŸ¥
    MSG->>MQ: æŠ•é€’åˆ°Kafkaé˜Ÿåˆ—
    
    MSG-->>GW: è¿”å›æˆåŠŸå“åº”
    GW-->>WS: WebSocketå“åº”
    WS-->>SDK: å”¤é†’ç­‰å¾…åç¨‹
    SDK->>SDK: æ›´æ–°æ¶ˆæ¯çŠ¶æ€å’Œæ—¶é—´
    SDK->>SDK: åˆ é™¤å‘é€ä¸­è®°å½•
    SDK-->>VM: å›è°ƒonSuccess
    VM->>UI: æ›´æ–°æ¶ˆæ¯æ˜¾ç¤º(å‘é€æˆåŠŸ)
    
    Note over MQ: åç»­å¼‚æ­¥å¤„ç†
    Note over MQ: åºåˆ—å·åˆ†é…ã€æŒä¹…åŒ–ã€æ¨é€ç­‰
```
