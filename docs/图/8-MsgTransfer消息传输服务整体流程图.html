<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MsgTransferæ¶ˆæ¯ä¼ è¾“æœåŠ¡æ•´ä½“æµç¨‹å›¾</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --accent-color: #3b82f6;
            --success-color: #059669;
            --warning-color: #d97706;
            --danger-color: #dc2626;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --border-radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: #1f2937;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .header p {
            color: #6b7280;
            font-size: 1.1rem;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        .btn.success {
            background: var(--success-color);
        }

        .btn.warning {
            background: var(--warning-color);
        }

        .status {
            text-align: center;
            margin: 15px 0;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            opacity: 0;
        }

        .status.show {
            opacity: 1;
        }

        .status.success {
            background: rgba(5, 150, 105, 0.1);
            color: var(--success-color);
            border: 2px solid rgba(5, 150, 105, 0.2);
        }

        .status.error {
            background: rgba(220, 38, 38, 0.1);
            color: var(--danger-color);
            border: 2px solid rgba(220, 38, 38, 0.2);
        }

        .diagram-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            padding: 30px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .diagram-wrapper {
            width: 100%;
            overflow: auto;
            cursor: grab;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            position: relative;
        }

        .diagram-wrapper:active {
            cursor: grabbing;
        }

        .diagram-wrapper svg {
            transition: transform 0.3s ease;
            max-width: none !important;
            height: auto !important;
        }

        .legend {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .legend h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .legend-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .legend-section h4 {
            color: var(--secondary-color);
            margin-bottom: 12px;
            font-weight: 600;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .color-box {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 10px;
            border: 1px solid #d1d5db;
        }

        .keyboard-shortcuts {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .keyboard-shortcuts h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .shortcuts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #4b5563;
        }

        .key {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .controls {
                gap: 10px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 13px;
            }

            .legend-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>MsgTransferæ¶ˆæ¯ä¼ è¾“æœåŠ¡æ•´ä½“æµç¨‹å›¾</h1>
            <p>OpenIMæ ¸å¿ƒç»„ä»¶ - æ¶ˆæ¯è½¬å‘ã€ç¼“å­˜ã€å»é‡å’ŒæŒä¹…åŒ–çš„å®Œæ•´æµç¨‹å±•ç¤º</p>
        </div>

        <div class="controls">
            <button class="btn" onclick="zoomIn()">æ”¾å¤§ (+)</button>
            <button class="btn" onclick="zoomOut()">ç¼©å° (-)</button>
            <button class="btn" onclick="resetZoom()">é‡ç½®ç¼©æ”¾</button>
            <button class="btn" onclick="toggleFullscreen()">å…¨å±åˆ‡æ¢</button>
            <button class="btn success" onclick="exportPNG()">å¯¼å‡ºPNG</button>
            <button class="btn warning" onclick="exportSVG()">å¯¼å‡ºSVG</button>
        </div>

        <div class="status" id="status"></div>

        <div class="diagram-container">
            <div class="diagram-wrapper" id="diagramWrapper">
                <div class="mermaid" id="mermaid-diagram">
                    graph TB
                    %% å®¢æˆ·ç«¯å±‚
                    subgraph "å®¢æˆ·ç«¯å±‚"
                    A1[å®¢æˆ·ç«¯Aå‘é€æ¶ˆæ¯]
                    A2[å®¢æˆ·ç«¯Bå‘é€æ¶ˆæ¯]
                    A3[æœ¬åœ°SQLiteå»é‡æ£€æŸ¥]
                    end

                    %% WebSocketç½‘å…³å±‚
                    subgraph "WebSocketç½‘å…³å±‚"
                    B1[WebSocketæœåŠ¡å™¨]
                    B2[è¿æ¥ç®¡ç†å™¨]
                    B3[æ¶ˆæ¯éªŒè¯å™¨]
                    end

                    %% Kafkaæ¶ˆæ¯é˜Ÿåˆ—
                    subgraph "Kafkaæ¶ˆæ¯é˜Ÿåˆ—"
                    C1[ToRedisTopicä¸»é¢˜]
                    C2[ToPushTopicä¸»é¢˜]
                    C3[ToMongoTopicä¸»é¢˜]
                    end

                    %% MsgTransferæ ¸å¿ƒæœåŠ¡
                    subgraph "MsgTransferæ ¸å¿ƒæœåŠ¡"
                    D1[OnlineHistoryRedisConsumerHandler]
                    D2[æ¶ˆæ¯æ‰¹å¤„ç†å™¨<br />500æ¡/æ‰¹æ¬¡, 100msé—´éš”]
                    D3[æ¶ˆæ¯åˆ†ç±»å™¨]
                    D4[OnlineHistoryMongoConsumerHandler]
                    end

                    %% Redisç¼“å­˜å±‚
                    subgraph "Redisç¼“å­˜å±‚"
                    E1[åºå·åˆ†é…å™¨<br />INCRBYåŸå­æ“ä½œ]
                    E2[æ¶ˆæ¯ç¼“å­˜<br />msg:conversationID:seq]
                    E3[å·²è¯»çŠ¶æ€ç¼“å­˜]
                    E4[åœ¨çº¿çŠ¶æ€ç¼“å­˜]
                    end

                    %% æ¶ˆæ¯å¤„ç†æµç¨‹
                    subgraph "æ¶ˆæ¯å¤„ç†æµç¨‹"
                    F1[æ¶ˆæ¯è§£æ]
                    F2[å»é‡æ£€æŸ¥]
                    F3[åºå·åˆ†é…]
                    F4[ç¼“å­˜å†™å…¥]
                    F5[åˆ†ç±»å¤„ç†]
                    F6[è½¬å‘å¤„ç†]
                    end

                    %% Pushæ¨é€æœåŠ¡
                    subgraph "Pushæ¨é€æœåŠ¡"
                    G1[åœ¨çº¿æ¨é€å¤„ç†å™¨]
                    G2[ç¦»çº¿æ¨é€å¤„ç†å™¨]
                    G3[WebSocketæ¨é€]
                    G4[APNs/FCMæ¨é€]
                    end

                    %% MongoDBæŒä¹…åŒ–
                    subgraph "MongoDBæŒä¹…åŒ–å±‚"
                    H1[æ¶ˆæ¯é›†åˆ]
                    H2[ä¼šè¯é›†åˆ]
                    H3[ç”¨æˆ·åºå·é›†åˆ]
                    H4[å†å²æ¶ˆæ¯ç´¢å¼•]
                    end

                    %% å…¶ä»–å¾®æœåŠ¡
                    subgraph "å…¶ä»–å¾®æœåŠ¡"
                    I1[GroupæœåŠ¡]
                    I2[ConversationæœåŠ¡]
                    I3[UseræœåŠ¡]
                    end

                    %% ç›‘æ§å’Œæ—¥å¿—
                    subgraph "ç›‘æ§å’Œæ—¥å¿—"
                    J1[Prometheusç›‘æ§]
                    J2[æ—¥å¿—æ”¶é›†]
                    J3[æ€§èƒ½æŒ‡æ ‡]
                    end

                    %% æ•°æ®æµè¿æ¥
                    A1 --> B1
                    A2 --> B1
                    A3 --> B1
                    B1 --> B2
                    B2 --> B3
                    B3 --> C1

                    C1 --> D1
                    D1 --> D2
                    D2 --> F1
                    F1 --> F2
                    F2 --> E1
                    E1 --> F3
                    F3 --> E2
                    E2 --> F4
                    F4 --> D3
                    D3 --> F5
                    F5 --> F6

                    %% è½¬å‘æµç¨‹
                    F6 --> C2
                    F6 --> C3
                    C2 --> G1
                    G1 --> G3
                    G1 --> G2
                    G2 --> G4

                    %% æŒä¹…åŒ–æµç¨‹
                    C3 --> D4
                    D4 --> H1
                    H1 --> H2
                    H2 --> H3
                    H3 --> H4

                    %% å¾®æœåŠ¡äº¤äº’
                    D1 --> I1
                    D1 --> I2
                    F5 --> I3

                    %% ç›‘æ§
                    D1 --> J1
                    D4 --> J1
                    F1 --> J2
                    E1 --> J3

                    %% æ ·å¼è®¾ç½®
                    classDef clientStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px,color:#000
                    classDef gatewayStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px,color:#000
                    classDef kafkaStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#000
                    classDef coreStyle fill:#e8f5e8,stroke:#1b5e20,stroke-width:3px,color:#000
                    classDef redisStyle fill:#ffebee,stroke:#b71c1c,stroke-width:2px,color:#000
                    classDef processStyle fill:#e3f2fd,stroke:#0d47a1,stroke-width:2px,color:#000
                    classDef pushStyle fill:#fce4ec,stroke:#880e4f,stroke-width:2px,color:#000
                    classDef mongoStyle fill:#e0f2f1,stroke:#004d40,stroke-width:2px,color:#000
                    classDef serviceStyle fill:#fff8e1,stroke:#ff6f00,stroke-width:2px,color:#000
                    classDef monitorStyle fill:#f1f8e9,stroke:#33691e,stroke-width:2px,color:#000

                    class A1,A2,A3 clientStyle
                    class B1,B2,B3 gatewayStyle
                    class C1,C2,C3 kafkaStyle
                    class D1,D2,D3,D4 coreStyle
                    class E1,E2,E3,E4 redisStyle
                    class F1,F2,F3,F4,F5,F6 processStyle
                    class G1,G2,G3,G4 pushStyle
                    class H1,H2,H3,H4 mongoStyle
                    class I1,I2,I3 serviceStyle
                    class J1,J2,J3 monitorStyle
                </div>
            </div>
        </div>

        <div class="legend">
            <h3>ğŸ“Š å›¾ä¾‹è¯´æ˜ä¸æŠ€æœ¯è¦ç‚¹</h3>

            <div class="legend-grid">
                <div class="legend-section">
                    <h4>ğŸ¨ é¢œè‰²å›¾ä¾‹</h4>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #e1f5fe;"></div>
                        <span>å®¢æˆ·ç«¯å±‚ - æ¶ˆæ¯å‘é€æºå¤´</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #f3e5f5;"></div>
                        <span>WebSocketç½‘å…³ - è¿æ¥ç®¡ç†</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #fff3e0;"></div>
                        <span>Kafkaé˜Ÿåˆ— - æ¶ˆæ¯ç¼“å†²</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #e8f5e8;"></div>
                        <span>MsgTransferæ ¸å¿ƒ - ä¸»å¤„ç†é€»è¾‘</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #ffebee;"></div>
                        <span>Redisç¼“å­˜ - é«˜é€Ÿå­˜å‚¨</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box" style="background-color: #e0f2f1;"></div>
                        <span>MongoDB - æŒä¹…åŒ–å­˜å‚¨</span>
                    </div>
                </div>

                <div class="legend-section">
                    <h4>ğŸ”„ æ ¸å¿ƒå¤„ç†æµç¨‹</h4>
                    <div class="legend-item">
                        <span><strong>1. æ¶ˆæ¯æ¥æ”¶ï¼š</strong>WebSocketç½‘å…³æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯</span>
                    </div>
                    <div class="legend-item">
                        <span><strong>2. é˜Ÿåˆ—ç¼“å†²ï¼š</strong>å‘é€åˆ°Kafka ToRedisTopicä¸»é¢˜</span>
                    </div>
                    <div class="legend-item">
                        <span><strong>3. æ‰¹é‡å¤„ç†ï¼š</strong>500æ¡æ¶ˆæ¯/æ‰¹æ¬¡ï¼Œ100msé—´éš”</span>
                    </div>
                    <div class="legend-item">
                        <span><strong>4. å»é‡åˆ†é…ï¼š</strong>Redis INCRBYåŸå­æ“ä½œåˆ†é…åºå·</span>
                    </div>
                    <div class="legend-item">
                        <span><strong>5. ç¼“å­˜å­˜å‚¨ï¼š</strong>å†™å…¥Redisï¼ŒTTL 24å°æ—¶</span>
                    </div>
                    <div class="legend-item">
                        <span><strong>6. æ¶ˆæ¯è½¬å‘ï¼š</strong>æ¨é€é˜Ÿåˆ— + æŒä¹…åŒ–é˜Ÿåˆ—</span>
                    </div>
                </div>

                <div class="legend-section">
                    <h4>âš¡ æ€§èƒ½ç‰¹ç‚¹</h4>
                    <div class="legend-item">
                        <span><strong>ååé‡ï¼š</strong>25ä¸‡æ¡æ¶ˆæ¯/ç§’ï¼ˆç†è®ºå€¼ï¼‰</span>
                    </div>
                    <div class="legend-item">
                        <span><strong>å»¶è¿Ÿï¼š</strong>Redis 1-5msï¼Œç«¯åˆ°ç«¯ 50-200ms</span>
                    </div>
                    <div class="legend-item">
                        <span><strong>å¹¶å‘ï¼š</strong>50ä¸ªå·¥ä½œåç¨‹å¹¶è¡Œå¤„ç†</span>
                    </div>
                    <div class="legend-item">
                        <span><strong>å»é‡ï¼š</strong>RedisåŸå­æ“ä½œç¡®ä¿æ¶ˆæ¯å”¯ä¸€æ€§</span>
                    </div>
                    <div class="legend-item">
                        <span><strong>ç¼“å­˜ï¼š</strong>24å°æ—¶TTLï¼Œå¹³è¡¡æ€§èƒ½å’Œæˆæœ¬</span>
                    </div>
                    <div class="legend-item">
                        <span><strong>åˆ†ç‰‡ï¼š</strong>æŒ‰ä¼šè¯IDåˆ†ç‰‡ï¼Œæ”¯æŒæ°´å¹³æ‰©å±•</span>
                    </div>
                </div>

                <div class="legend-section">
                    <h4>ğŸ¯ å…³é”®æŠ€æœ¯ç‚¹</h4>
                    <div class="legend-item">
                        <span><strong>æ¶ˆæ¯å»é‡ï¼š</strong>Redis INCRBYåŸå­æ“ä½œ</span>
                    </div>
                    <div class="legend-item">
                        <span><strong>æ‰¹å¤„ç†ä¼˜åŒ–ï¼š</strong>å‡å°‘ç³»ç»Ÿè°ƒç”¨ï¼Œæé«˜åå</span>
                    </div>
                    <div class="legend-item">
                        <span><strong>å¼‚æ­¥å¤„ç†ï¼š</strong>å·²è¯»çŠ¶æ€å¼‚æ­¥æ›´æ–°</span>
                    </div>
                    <div class="legend-item">
                        <span><strong>åˆ†ç±»å¤„ç†ï¼š</strong>å­˜å‚¨/éå­˜å‚¨ï¼Œé€šçŸ¥/æ™®é€š</span>
                    </div>
                    <div class="legend-item">
                        <span><strong>ç›‘æ§é›†æˆï¼š</strong>PrometheusæŒ‡æ ‡ç»Ÿè®¡</span>
                    </div>
                    <div class="legend-item">
                        <span><strong>æ•…éšœæ¢å¤ï¼š</strong>Kafkaåç§»é‡ç®¡ç†</span>
                    </div>
                </div>
            </div>

            <div class="keyboard-shortcuts">
                <h4>âŒ¨ï¸ å¿«æ·é”®æ“ä½œ</h4>
                <div class="shortcuts-grid">
                    <div class="shortcut-item">
                        <span>æ”¾å¤§</span>
                        <span class="key">Ctrl + +</span>
                    </div>
                    <div class="shortcut-item">
                        <span>ç¼©å°</span>
                        <span class="key">Ctrl + -</span>
                    </div>
                    <div class="shortcut-item">
                        <span>é‡ç½®</span>
                        <span class="key">Ctrl + 0</span>
                    </div>
                    <div class="shortcut-item">
                        <span>å…¨å±</span>
                        <span class="key">F11</span>
                    </div>
                    <div class="shortcut-item">
                        <span>æ‹–æ‹½ç§»åŠ¨</span>
                        <span class="key">é¼ æ ‡æ‹–æ‹½</span>
                    </div>
                    <div class="shortcut-item">
                        <span>æ»šè½®ç¼©æ”¾</span>
                        <span class="key">Ctrl + æ»šè½®</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentZoom = 1;
        let isDragging = false;
        let startX, startY, translateX = 0, translateY = 0;

        // åˆå§‹åŒ–Mermaid
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                fontFamily: 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif',
                fontSize: '14px',
                primaryColor: '#e3f2fd',
                primaryTextColor: '#1a1a1a',
                primaryBorderColor: '#1976d2',
                lineColor: '#424242',
                secondaryColor: '#f5f5f5',
                tertiaryColor: '#e8f5e8'
            },
            flowchart: {
                useMaxWidth: false,
                htmlLabels: true,
                curve: 'basis',
                padding: 20,
                nodeSpacing: 50,
                rankSpacing: 60
            }
        });

        // çŠ¶æ€æ˜¾ç¤ºå‡½æ•°
        function showStatus(message, type = 'success') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status show ${type}`;

            setTimeout(() => {
                status.classList.remove('show');
            }, 3000);
        }

        // ç¼©æ”¾åŠŸèƒ½
        function zoomIn() {
            currentZoom = Math.min(currentZoom * 1.2, 3);
            applyTransform();
            showStatus('å›¾è¡¨å·²æ”¾å¤§');
        }

        function zoomOut() {
            currentZoom = Math.max(currentZoom * 0.8, 0.3);
            applyTransform();
            showStatus('å›¾è¡¨å·²ç¼©å°');
        }

        function resetZoom() {
            currentZoom = 1;
            translateX = 0;
            translateY = 0;
            applyTransform();
            showStatus('ç¼©æ”¾å·²é‡ç½®');
        }

        function applyTransform() {
            const svg = document.querySelector('#mermaid-diagram svg');
            if (svg) {
                svg.style.transform = `scale(${currentZoom}) translate(${translateX}px, ${translateY}px)`;
            }
        }

        // æ‹–æ‹½åŠŸèƒ½
        function setupDragFunctionality() {
            const wrapper = document.getElementById('diagramWrapper');

            wrapper.addEventListener('mousedown', startDrag);
            wrapper.addEventListener('touchstart', startDrag);

            document.addEventListener('mousemove', drag);
            document.addEventListener('touchmove', drag);

            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
        }

        function startDrag(e) {
            isDragging = true;
            const event = e.touches ? e.touches[0] : e;
            startX = event.clientX - translateX;
            startY = event.clientY - translateY;
            e.preventDefault();
        }

        function drag(e) {
            if (!isDragging) return;

            const event = e.touches ? e.touches[0] : e;
            translateX = event.clientX - startX;
            translateY = event.clientY - startY;

            applyTransform();
            e.preventDefault();
        }

        function endDrag() {
            isDragging = false;
        }

        // æ»šè½®ç¼©æ”¾
        function setupWheelZoom() {
            const wrapper = document.getElementById('diagramWrapper');

            wrapper.addEventListener('wheel', (e) => {
                if (e.ctrlKey) {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? 0.9 : 1.1;
                    currentZoom = Math.max(0.3, Math.min(3, currentZoom * delta));
                    applyTransform();
                }
            });
        }

        // å…¨å±åŠŸèƒ½
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().then(() => {
                    showStatus('å·²è¿›å…¥å…¨å±æ¨¡å¼');
                }).catch(() => {
                    showStatus('å…¨å±æ¨¡å¼å¤±è´¥', 'error');
                });
            } else {
                document.exitFullscreen().then(() => {
                    showStatus('å·²é€€å‡ºå…¨å±æ¨¡å¼');
                });
            }
        }

        // å¯¼å‡ºPNGåŠŸèƒ½
        async function exportPNG() {
            try {
                showStatus('æ­£åœ¨ç”ŸæˆPNGå›¾ç‰‡...', 'success');

                // ç­‰å¾…Mermaidæ¸²æŸ“å®Œæˆ
                await new Promise(resolve => setTimeout(resolve, 1000));

                const svg = document.querySelector('#mermaid-diagram svg');
                if (!svg) {
                    throw new Error('æœªæ‰¾åˆ°SVGå…ƒç´ ');
                }

                // åˆ›å»ºcanvas
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                // è·å–SVGå°ºå¯¸
                const svgRect = svg.getBoundingClientRect();
                const svgData = new XMLSerializer().serializeToString(svg);

                // è®¾ç½®canvaså°ºå¯¸
                canvas.width = svgRect.width * 2; // æé«˜åˆ†è¾¨ç‡
                canvas.height = svgRect.height * 2;

                // åˆ›å»ºå›¾ç‰‡
                const img = new Image();
                const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(svgBlob);

                img.onload = function () {
                    // è®¾ç½®ç™½è‰²èƒŒæ™¯
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    // ç»˜åˆ¶SVGåˆ°canvas
                    ctx.scale(2, 2); // æé«˜åˆ†è¾¨ç‡
                    ctx.drawImage(img, 0, 0);

                    // å¯¼å‡ºPNG
                    canvas.toBlob(function (blob) {
                        const link = document.createElement('a');
                        link.download = 'MsgTransferæ¶ˆæ¯ä¼ è¾“æœåŠ¡æ•´ä½“æµç¨‹å›¾.png';
                        link.href = URL.createObjectURL(blob);
                        link.click();

                        // æ¸…ç†URL
                        URL.revokeObjectURL(url);
                        URL.revokeObjectURL(link.href);

                        showStatus('PNGå›¾ç‰‡å¯¼å‡ºæˆåŠŸï¼');
                    });
                };

                img.onerror = function () {
                    throw new Error('å›¾ç‰‡åŠ è½½å¤±è´¥');
                };

                img.src = url;

            } catch (error) {
                console.error('PNGå¯¼å‡ºå¤±è´¥:', error);
                showStatus('PNGå¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¯¼å‡ºSVGåŠŸèƒ½
        function exportSVG() {
            try {
                showStatus('æ­£åœ¨å¯¼å‡ºSVG...', 'success');

                const svg = document.querySelector('#mermaid-diagram svg');
                if (!svg) {
                    throw new Error('æœªæ‰¾åˆ°SVGå…ƒç´ ');
                }

                const svgData = new XMLSerializer().serializeToString(svg);
                const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });

                const link = document.createElement('a');
                link.download = 'MsgTransferæ¶ˆæ¯ä¼ è¾“æœåŠ¡æ•´ä½“æµç¨‹å›¾.svg';
                link.href = URL.createObjectURL(svgBlob);
                link.click();

                URL.revokeObjectURL(link.href);
                showStatus('SVGæ–‡ä»¶å¯¼å‡ºæˆåŠŸï¼');

            } catch (error) {
                console.error('SVGå¯¼å‡ºå¤±è´¥:', error);
                showStatus('SVGå¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function (e) {
            if (e.ctrlKey) {
                switch (e.code) {
                    case 'Equal':
                    case 'NumpadAdd':
                        e.preventDefault();
                        zoomIn();
                        break;
                    case 'Minus':
                    case 'NumpadSubtract':
                        e.preventDefault();
                        zoomOut();
                        break;
                    case 'Digit0':
                    case 'Numpad0':
                        e.preventDefault();
                        resetZoom();
                        break;
                }
            } else if (e.code === 'F11') {
                e.preventDefault();
                toggleFullscreen();
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            // ç­‰å¾…Mermaidæ¸²æŸ“å®Œæˆ
            setTimeout(() => {
                setupDragFunctionality();
                setupWheelZoom();
                showStatus('MsgTransferæµç¨‹å›¾åŠ è½½å®Œæˆï¼');
            }, 1000);
        });

        // ç›‘å¬Mermaidæ¸²æŸ“å®Œæˆäº‹ä»¶
        mermaid.mermaidAPI.initialize({
            startOnLoad: true,
            callback: function () {
                console.log('Mermaidæ¸²æŸ“å®Œæˆ');
            }
        });
    </script>
</body>

</html>