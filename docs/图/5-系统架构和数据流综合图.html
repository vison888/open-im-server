<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenIMç³»ç»Ÿæ¶æ„å’Œæ•°æ®æµç»¼åˆå›¾</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #30e8bf 0%, #ff8235 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            margin: 10px 0 0 0;
            font-size: 1.2em;
            opacity: 0.9;
        }

        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(135deg, #30e8bf 0%, #ff8235 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .zoom-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
        }

        .diagram-container {
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 600px;
            overflow: auto;
            background: #ffffff;
        }

        .mermaid-container {
            transform-origin: center center;
            transition: transform 0.3s ease;
            max-width: 100%;
            overflow: visible;
        }

        .description {
            padding: 30px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .description h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .description ul {
            color: #555;
            line-height: 1.8;
        }

        .description li {
            margin-bottom: 8px;
        }

        .highlight {
            background: linear-gradient(120deg, #a8edea 0%, #fed6e3 100%);
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 500;
        }

        .layer-desc {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }

        .layer-desc h4 {
            margin-top: 0;
            color: #2c3e50;
        }

        .tech-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .tech-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .tech-card h4 {
            margin-top: 0;
            color: #fff;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .controls {
                flex-direction: column;
                align-items: center;
            }

            .zoom-controls {
                justify-content: center;
            }

            .tech-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>OpenIMç³»ç»Ÿæ¶æ„å’Œæ•°æ®æµç»¼åˆå›¾</h1>
            <p>å±•ç¤ºå®Œæ•´çš„å¾®æœåŠ¡æ¶æ„ã€å­˜å‚¨å±‚ã€ä¸­é—´ä»¶ä»¥åŠæ•°æ®æµè½¬è¿‡ç¨‹</p>
        </div>

        <div class="controls">
            <div class="zoom-controls">
                <button class="btn zoom-btn" onclick="zoomOut()">-</button>
                <span id="zoomLevel">100%</span>
                <button class="btn zoom-btn" onclick="zoomIn()">+</button>
            </div>
            <button class="btn" onclick="resetZoom()">é‡ç½®ç¼©æ”¾</button>
            <button class="btn" onclick="exportPNG()">å¯¼å‡ºPNG</button>
            <button class="btn" onclick="exportSVG()">å¯¼å‡ºSVG</button>
            <button class="btn" onclick="toggleFullscreen()">å…¨å±æŸ¥çœ‹</button>
        </div>

        <div class="diagram-container" id="diagramContainer">
            <div class="mermaid-container" id="mermaidContainer">
                <div class="mermaid" id="diagram">
                    graph TB
                    subgraph "å®¢æˆ·ç«¯å±‚"
                    A[Androidå®¢æˆ·ç«¯]
                    B[iOSå®¢æˆ·ç«¯]
                    C[Webå®¢æˆ·ç«¯]
                    A --> D[WebSocketè¿æ¥]
                    B --> D
                    C --> D
                    end

                    subgraph "ç½‘å…³å±‚ - Gateway"
                    D --> E[æ¶ˆæ¯ç½‘å…³<br />ws_server.go]
                    E --> F[è¿æ¥ç®¡ç†<br />è¿æ¥æ±  + å¿ƒè·³æ£€æµ‹]
                    E --> G[èº«ä»½éªŒè¯<br />TokenéªŒè¯]
                    E --> H[æ¶ˆæ¯è·¯ç”±<br />è¯·æ±‚åˆ†å‘]
                    end

                    subgraph "ä¸šåŠ¡æœåŠ¡å±‚ - Business Services"
                    H --> I[msgæœåŠ¡<br />send.go]
                    I --> J[æ¶ˆæ¯éªŒè¯<br />å¥½å‹å…³ç³»/é»‘åå•]
                    I --> K[æ¶ˆæ¯å¤„ç†<br />ç”ŸæˆServerMsgID]
                    I --> L[æƒé™æ£€æŸ¥<br />æ¥æ”¶æ–¹è®¾ç½®]

                    M[authæœåŠ¡<br />ç”¨æˆ·è®¤è¯]
                    N[useræœåŠ¡<br />ç”¨æˆ·ç®¡ç†]
                    O[friendæœåŠ¡<br />å¥½å‹å…³ç³»]
                    P[groupæœåŠ¡<br />ç¾¤ç»„ç®¡ç†]
                    Q[pushæœåŠ¡<br />æ¨é€å¤„ç†]
                    end

                    subgraph "æ¶ˆæ¯é˜Ÿåˆ—å±‚ - Message Queue"
                    K --> R[Kafka Cluster]
                    R --> S[ToRedisTopic<br />æ¶ˆæ¯åˆ†å‘ä¸»é¢˜]
                    R --> T[toPushTopic<br />æ¨é€é˜Ÿåˆ—]
                    R --> U[MsgToMongoMQ<br />æŒä¹…åŒ–é˜Ÿåˆ—]
                    end

                    subgraph "æ¶ˆæ¯å¤„ç†å±‚ - Message Processing"
                    S --> V[MsgTransferæœåŠ¡<br />online_history_msg_handler.go]
                    V --> W[æ‰¹é‡æ¶ˆæ¯æ¶ˆè´¹<br />parseConsumerMessages]
                    V --> X[æ¶ˆæ¯åˆ†ç±»å¤„ç†<br />categorizeMessageLists]
                    V --> Y[Redisåºå·åˆ†é…<br />seqConversation.Malloc]
                    Y --> Z[INCRBYåŸå­æ“ä½œ<br />å”¯ä¸€åºå·ç”Ÿæˆ]
                    end

                    subgraph "ç¼“å­˜å±‚ - Cache Layer"
                    Z --> AA[Redis Cluster]
                    AA --> AB[æ¶ˆæ¯ç¼“å­˜<br />msg:conversationID:seq]
                    AA --> AC[åºå·ç®¡ç†<br />seq:conversationID]
                    AA --> AD[ç”¨æˆ·åœ¨çº¿çŠ¶æ€<br />user:online:status]
                    AA --> AE[ä¼šè¯åºå·<br />conversation:seq]
                    AB --> AF[24å°æ—¶TTL<br />è‡ªåŠ¨è¿‡æœŸæ¸…ç†]
                    end

                    subgraph "æ¨é€å¤„ç†å±‚ - Push Processing"
                    T --> AG[PushæœåŠ¡<br />push_handler.go]
                    AG --> AH[åœ¨çº¿çŠ¶æ€æŸ¥è¯¢<br />onlineCache.GetUsersOnline]
                    AH --> AI{ç”¨æˆ·åœ¨çº¿?}
                    AI -->|åœ¨çº¿| AJ[WebSocketæ¨é€<br />onlinePusher.GetConnsAndOnlinePush]
                    AI -->|ç¦»çº¿| AK[ç¦»çº¿æ¨é€<br />offlinePushMsg]
                    AJ --> AL[å®æ—¶æ¶ˆæ¯æ¨é€<br />WSPushMsg: 2001]
                    AK --> AM[APNs/FCMæ¨é€<br />ç¬¬ä¸‰æ–¹æ¨é€æœåŠ¡]
                    end

                    subgraph "æŒä¹…åŒ–å±‚ - Persistence Layer"
                    U --> AN[æ¶ˆæ¯æŒä¹…åŒ–æœåŠ¡<br />online_msg_to_mongo_handler.go]
                    AN --> AO[æ‰¹é‡å†™å…¥å¤„ç†<br />BatchInsertChat2DB]
                    AO --> AP[MongoDB Cluster]
                    AP --> AQ[æ¶ˆæ¯é›†åˆ<br />chat_records]
                    AP --> AR[ç”¨æˆ·é›†åˆ<br />users]
                    AP --> AS[ä¼šè¯é›†åˆ<br />conversations]
                    AP --> AT[ç´¢å¼•ä¼˜åŒ–<br />æŸ¥è¯¢æ€§èƒ½æå‡]
                    end

                    subgraph "ç›‘æ§å’Œè¿ç»´å±‚ - Operations"
                    AU[Prometheusç›‘æ§]
                    AV[Grafanaä»ªè¡¨æ¿]
                    AW[æ—¥å¿—èšåˆELK]
                    AX[åˆ†å¸ƒå¼è¿½è¸ªJaeger]
                    AU --> AV
                    AW --> AX
                    end

                    %% æ•°æ®æµæ ‡è¯†
                    D -.->|1. WebSocketè¿æ¥| E
                    I -.->|2. æ¶ˆæ¯éªŒè¯å¤„ç†| K
                    K -.->|3. Kafkaåˆ†å‘| S
                    V -.->|4. æ¶ˆæ¯æ¶ˆè´¹å¤„ç†| Y
                    Z -.->|5. Redisç¼“å­˜å†™å…¥| AB
                    AG -.->|6. æ¨é€å¤„ç†| AI
                    AN -.->|7. MongoDBæŒä¹…åŒ–| AP

                    %% æ ·å¼è®¾ç½®
                    style E fill:#e1f5fe,stroke:#01579b,stroke-width:2px
                    style I fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
                    style V fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
                    style Z fill:#ffcdd2,stroke:#d32f2f,stroke-width:3px
                    style AG fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
                    style AN fill:#e0f2f1,stroke:#00695c,stroke-width:2px
                </div>
            </div>
        </div>

        <div class="description">
            <h3>ç³»ç»Ÿæ¶æ„æ ¸å¿ƒç»„ä»¶</h3>

            <div class="tech-grid">
                <div class="tech-card">
                    <h4>ğŸŒ å®¢æˆ·ç«¯å±‚</h4>
                    <p><strong>æ”¯æŒå¹³å°ï¼š</strong>Androidã€iOSã€Webã€PC</p>
                    <p><strong>é€šä¿¡åè®®ï¼š</strong>WebSocketé•¿è¿æ¥</p>
                    <p><strong>ç‰¹æ€§ï¼š</strong>æ–­çº¿é‡è¿ã€æ¶ˆæ¯ç¼“å­˜ã€çŠ¶æ€åŒæ­¥</p>
                </div>

                <div class="tech-card">
                    <h4>ğŸšª ç½‘å…³å±‚</h4>
                    <p><strong>æ ¸å¿ƒåŠŸèƒ½ï¼š</strong>è¿æ¥ç®¡ç†ã€è´Ÿè½½å‡è¡¡ã€èº«ä»½éªŒè¯</p>
                    <p><strong>æŠ€æœ¯æ ˆï¼š</strong>Goã€WebSocketã€JWTè®¤è¯</p>
                    <p><strong>æ€§èƒ½ï¼š</strong>æ”¯æŒç™¾ä¸‡çº§å¹¶å‘è¿æ¥</p>
                </div>

                <div class="tech-card">
                    <h4>âš™ï¸ ä¸šåŠ¡æœåŠ¡å±‚</h4>
                    <p><strong>å¾®æœåŠ¡ï¼š</strong>msgã€userã€friendã€groupã€push</p>
                    <p><strong>æ¶æ„ï¼š</strong>æ— çŠ¶æ€è®¾è®¡ã€æ°´å¹³æ‰©å±•</p>
                    <p><strong>é€šä¿¡ï¼š</strong>gRPCå†…éƒ¨é€šä¿¡</p>
                </div>

                <div class="tech-card">
                    <h4>ğŸ“¨ æ¶ˆæ¯é˜Ÿåˆ—</h4>
                    <p><strong>ä¸­é—´ä»¶ï¼š</strong>Apache Kafka</p>
                    <p><strong>ä¸»é¢˜ï¼š</strong>æ¶ˆæ¯åˆ†å‘ã€æ¨é€ã€æŒä¹…åŒ–</p>
                    <p><strong>ç‰¹æ€§ï¼š</strong>é«˜ååé‡ã€æ¶ˆæ¯é¡ºåºä¿è¯</p>
                </div>

                <div class="tech-card">
                    <h4>ğŸš€ ç¼“å­˜å±‚</h4>
                    <p><strong>æŠ€æœ¯ï¼š</strong>Redis Clusteré›†ç¾¤</p>
                    <p><strong>åŠŸèƒ½ï¼š</strong>æ¶ˆæ¯ç¼“å­˜ã€åºå·ç®¡ç†ã€åœ¨çº¿çŠ¶æ€</p>
                    <p><strong>æ€§èƒ½ï¼š</strong>äºšæ¯«ç§’çº§è®¿é—®å»¶è¿Ÿ</p>
                </div>

                <div class="tech-card">
                    <h4>ğŸ’¾ æŒä¹…åŒ–å±‚</h4>
                    <p><strong>æ•°æ®åº“ï¼š</strong>MongoDBåˆ†ç‰‡é›†ç¾¤</p>
                    <p><strong>å­˜å‚¨ï¼š</strong>æ¶ˆæ¯è®°å½•ã€ç”¨æˆ·æ•°æ®ã€ä¼šè¯ä¿¡æ¯</p>
                    <p><strong>ä¼˜åŒ–ï¼š</strong>ç´¢å¼•ä¼˜åŒ–ã€åˆ†ç‰‡ç­–ç•¥</p>
                </div>
            </div>

            <div class="layer-desc">
                <h4>æ•°æ®æµè½¬è¿‡ç¨‹ï¼ˆ7ä¸ªå…³é”®æ­¥éª¤ï¼‰</h4>
                <ol>
                    <li><strong>WebSocketè¿æ¥ï¼š</strong>å®¢æˆ·ç«¯é€šè¿‡ç½‘å…³å»ºç«‹é•¿è¿æ¥</li>
                    <li><strong>æ¶ˆæ¯éªŒè¯å¤„ç†ï¼š</strong>msgæœåŠ¡éªŒè¯æƒé™å’Œå…³ç³»</li>
                    <li><strong>Kafkaåˆ†å‘ï¼š</strong>æ¶ˆæ¯è¿›å…¥æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿ</li>
                    <li><strong>æ¶ˆæ¯æ¶ˆè´¹å¤„ç†ï¼š</strong>MsgTransferæœåŠ¡æ¶ˆè´¹å¤„ç†</li>
                    <li><strong>Redisç¼“å­˜å†™å…¥ï¼š</strong>åˆ†é…åºå·å¹¶ç¼“å­˜æ¶ˆæ¯</li>
                    <li><strong>æ¨é€å¤„ç†ï¼š</strong>æ ¹æ®åœ¨çº¿çŠ¶æ€æ¨é€æ¶ˆæ¯</li>
                    <li><strong>MongoDBæŒä¹…åŒ–ï¼š</strong>æ¶ˆæ¯æ°¸ä¹…å­˜å‚¨</li>
                </ol>
            </div>

            <div class="layer-desc">
                <h4>ç³»ç»Ÿè®¾è®¡äº®ç‚¹</h4>
                <ul>
                    <li><strong>å¾®æœåŠ¡æ¶æ„ï¼š</strong>æœåŠ¡è§£è€¦ï¼Œç‹¬ç«‹éƒ¨ç½²å’Œæ‰©å±•</li>
                    <li><strong>å¼‚æ­¥å¤„ç†ï¼š</strong>Kafkaå¼‚æ­¥æ¶ˆæ¯å¤„ç†ï¼Œæé«˜å“åº”é€Ÿåº¦</li>
                    <li><strong>åˆ†å±‚ç¼“å­˜ï¼š</strong>Rediså¤šçº§ç¼“å­˜ï¼Œä¼˜åŒ–è¯»å–æ€§èƒ½</li>
                    <li><strong>æ°´å¹³æ‰©å±•ï¼š</strong>æ‰€æœ‰ç»„ä»¶æ”¯æŒé›†ç¾¤éƒ¨ç½²</li>
                    <li><strong>æ•…éšœéš”ç¦»ï¼š</strong>æœåŠ¡é—´æ•…éšœä¸ä¼šç›¸äº’å½±å“</li>
                    <li><strong>å¯è§‚æµ‹æ€§ï¼š</strong>å®Œæ•´çš„ç›‘æ§ã€æ—¥å¿—ã€è¿½è¸ªä½“ç³»</li>
                </ul>
            </div>

            <h3>æŠ€æœ¯æ ˆæ€»è§ˆ</h3>
            <ul>
                <li><span class="highlight">åç«¯è¯­è¨€</span>ï¼šGo (Golang)</li>
                <li><span class="highlight">é€šä¿¡åè®®</span>ï¼šWebSocketã€gRPCã€HTTP</li>
                <li><span class="highlight">æ¶ˆæ¯é˜Ÿåˆ—</span>ï¼šApache Kafka</li>
                <li><span class="highlight">ç¼“å­˜ç³»ç»Ÿ</span>ï¼šRedis Cluster</li>
                <li><span class="highlight">æ•°æ®å­˜å‚¨</span>ï¼šMongoDB</li>
                <li><span class="highlight">ç›‘æ§è¿ç»´</span>ï¼šPrometheusã€Grafanaã€ELKã€Jaeger</li>
            </ul>
        </div>
    </div>

    <script>
        let currentZoom = 1;
        let mermaidContainer = document.getElementById('mermaidContainer');

        // åˆå§‹åŒ–Mermaid
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: false,
                htmlLabels: true,
                curve: 'basis'
            }
        });

        function zoomIn() {
            currentZoom = Math.min(currentZoom + 0.2, 3);
            updateZoom();
        }

        function zoomOut() {
            currentZoom = Math.max(currentZoom - 0.2, 0.3);
            updateZoom();
        }

        function resetZoom() {
            currentZoom = 1;
            updateZoom();
        }

        function updateZoom() {
            mermaidContainer.style.transform = `scale(${currentZoom})`;
            document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
        }

        function exportPNG() {
            const svg = document.querySelector('#diagram svg');
            if (!svg) {
                alert('è¯·ç­‰å¾…å›¾è¡¨åŠ è½½å®Œæˆ');
                return;
            }

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const data = new XMLSerializer().serializeToString(svg);
            const img = new Image();

            const svgBlob = new Blob([data], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(svgBlob);

            img.onload = function () {
                canvas.width = img.width * 2;
                canvas.height = img.height * 2;
                ctx.scale(2, 2);
                ctx.drawImage(img, 0, 0);

                canvas.toBlob(function (blob) {
                    const link = document.createElement('a');
                    link.download = 'OpenIMç³»ç»Ÿæ¶æ„å’Œæ•°æ®æµç»¼åˆå›¾.png';
                    link.href = URL.createObjectURL(blob);
                    link.click();
                    URL.revokeObjectURL(url);
                });
            };

            img.src = url;
        }

        function exportSVG() {
            const svg = document.querySelector('#diagram svg');
            if (!svg) {
                alert('è¯·ç­‰å¾…å›¾è¡¨åŠ è½½å®Œæˆ');
                return;
            }

            const data = new XMLSerializer().serializeToString(svg);
            const blob = new Blob([data], { type: 'image/svg+xml;charset=utf-8' });
            const link = document.createElement('a');
            link.download = 'OpenIMç³»ç»Ÿæ¶æ„å’Œæ•°æ®æµç»¼åˆå›¾.svg';
            link.href = URL.createObjectURL(blob);
            link.click();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // é¼ æ ‡æ»šè½®ç¼©æ”¾
        document.getElementById('diagramContainer').addEventListener('wheel', function (e) {
            if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                if (e.deltaY < 0) {
                    zoomIn();
                } else {
                    zoomOut();
                }
            }
        });

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function (e) {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case '=':
                    case '+':
                        e.preventDefault();
                        zoomIn();
                        break;
                    case '-':
                        e.preventDefault();
                        zoomOut();
                        break;
                    case '0':
                        e.preventDefault();
                        resetZoom();
                        break;
                }
            }
        });
    </script>
</body>

</html>